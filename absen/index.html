<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absen Online Daily Worker I.B.L.</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Plus Jakarta Sans', sans-serif;
    }
    
    .glass-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .worker-card {
      transition: all 0.15s ease;
    }
    
    .worker-card.selected {
      background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%) !important;
      border: 3px solid #be185d !important;
    }
    
    .worker-card.selected * {
      color: white !important;
    }
    
    .worker-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    }
    
    .status-btn {
      transition: all 0.15s ease;
    }
    
    .status-btn:hover {
      transform: scale(1.05);
    }
    
    .status-btn.active {
      ring: 3px;
      ring-offset: 2px;
    }
    
    .recap-table th:first-child,
    .recap-table td:first-child {
      position: sticky;
      left: 0;
      z-index: 10;
      background: inherit;
    }
    
    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      white-space: nowrap;
    }
    
    .badge-start { background: #dcfce7; color: #166534; }
    .badge-finish { background: #dbeafe; color: #1e40af; }
    .badge-sakit { background: #fef3c7; color: #92400e; }
    .badge-standby { background: #f3e8ff; color: #7c3aed; }
    .badge-belum { background: #fee2e2; color: #dc2626; }
    
    .calendar-day {
      transition: all 0.2s ease;
    }
    
    .calendar-day:hover {
      transform: scale(1.1);
    }
    
    .calendar-day.has-data {
      background: #10b981;
      color: white;
    }
    
    .photo-grid img {
      transition: all 0.3s ease;
    }
    
    .photo-grid img:hover {
      transform: scale(1.05);
    }
    
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    ::-webkit-scrollbar-track {
      background: #f1f5f9;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 10px;
    }
    
    ::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
    
    .logo-white {
      filter: brightness(0) invert(1);
    }
    
    .dark-blue-bg {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f2744 50%, #1a365d 100%);
    }
    
    .navy-card {
      background: linear-gradient(135deg, #1e3a5f 0%, #0f2744 100%);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full dark-blue-bg">
  <div id="app" class="h-full overflow-auto"></div><!-- Toast Container -->
  <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-[100]"></div><!-- Photo Preview Confirmation Modal -->
  <div id="photo-confirm-modal" class="fixed inset-0 bg-black/90 z-[60] hidden items-center justify-center p-4">
   <div class="bg-white rounded-3xl max-w-lg w-full overflow-hidden shadow-2xl">
    <div class="p-4 bg-slate-100 border-b">
     <h3 class="text-lg font-bold text-slate-800 text-center">Preview Foto</h3>
     <p id="photo-counter" class="text-sm text-slate-500 text-center mt-1"></p>
    </div>
    <div class="p-4"><img id="confirm-preview-image" class="w-full max-h-[60vh] object-contain rounded-xl" alt="Preview">
    </div>
    <div class="p-4 bg-slate-50 flex gap-3"><button onclick="retakePhoto()" class="flex-1 py-3 bg-slate-600 hover:bg-slate-700 text-white font-semibold rounded-xl transition flex items-center justify-center gap-2"> üîÑ Ambil Ulang </button> <button onclick="confirmPhoto()" class="flex-1 py-3 bg-emerald-500 hover:bg-emerald-600 text-white font-semibold rounded-xl transition flex items-center justify-center gap-2"> ‚úÖ Gunakan Foto </button>
    </div>
   </div>
  </div><!-- Gallery Full Preview Modal -->
  <div id="gallery-preview-modal" class="fixed inset-0 bg-black z-[70] hidden flex-col">
   <div class="absolute top-4 left-4 right-4 flex items-center justify-between z-10"><span id="gallery-counter" class="text-white text-sm bg-black/50 px-3 py-1 rounded-full"></span> <button onclick="closeGalleryPreview()" class="bg-white/20 hover:bg-white/40 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-bold transition"> √ó </button>
   </div>
   <div class="flex-1 flex items-center justify-center p-4"><button onclick="prevGalleryPhoto()" id="gallery-prev-btn" class="absolute left-2 bg-white/20 hover:bg-white/40 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl transition z-10"> ‚Äπ </button> <img id="gallery-preview-image" class="max-w-full max-h-full object-contain" alt="Preview foto"> <button onclick="nextGalleryPhoto()" id="gallery-next-btn" class="absolute right-2 bg-white/20 hover:bg-white/40 text-white w-12 h-12 rounded-full flex items-center justify-center text-2xl transition z-10"> ‚Ä∫ </button>
   </div>
  </div>
  <script>
    // ==================== CONFIG & STATE ====================
    const STORAGE_KEY = 'archipelago_attendance_data';
    const CREDENTIALS = { username: 'archipelago', password: 'balivibes' };
    
    const WORKERS = [
      'Kadek Suardana', 'Putu Eka Juliantara', 'Wayan Rai Darmawan', 'Made Adi Suryawan',
      'Ketut Agus Wirawan', 'Nyoman Sukerta', 'Gede Darma Putra', 'Komang Triadi',
      'Dewa Putu Arnawa', 'I Made Sudiarta', 'Wayan Sudiarsa', 'Putu Gede Artawan',
      'Kadek Arta Wijaya', 'Made Budiana', 'Ketut Suwitra', 'Nyoman Ardika',
      'Gede Pasek Suartana', 'Komang Alit Sudana', 'Dewa Made Rai', 'I Wayan Sukadana',
      'Putu Agus Mahendra', 'Kadek Dwi Putra', 'Made Yoga Pratama', 'Ketut Bagiarta',
      'Nyoman Widnyana', 'Gede Eka Putra', 'Komang Suardika', 'Dewa Ketut Alit',
      'I Made Artika', 'Wayan Gede Astawa'
    ];
    
    const STATUSES = ['Start Work', 'Finish Work', 'Sakit', 'Standby'];
    
    const STATUS_COLORS = {
      'Start Work': { bg: 'bg-emerald-500', hover: 'hover:bg-emerald-600', badge: 'badge-start' },
      'Finish Work': { bg: 'bg-blue-500', hover: 'hover:bg-blue-600', badge: 'badge-finish' },
      'Sakit': { bg: 'bg-orange-500', hover: 'hover:bg-orange-600', badge: 'badge-sakit' },
      'Standby': { bg: 'bg-purple-500', hover: 'hover:bg-purple-600', badge: 'badge-standby' }
    };
    
    let state = {
      currentPage: 'login',
      isLoggedIn: false,
      selectedWorkers: {},
      searchQuery: '',
      photos: [],
      photosFullRes: [],
      isSubmitting: false,
      calendarDate: new Date(),
      selectedRecapDate: null
    };
    
    // Photo preview queue state
    let photoQueue = [];
    let photoQueueFullRes = [];
    let currentPreviewIndex = 0;
    let pendingFiles = [];
    
    // Gallery preview state
    let galleryPhotos = [];
    let galleryCurrentIndex = 0;
    
    let config = {
      app_title: 'ABSEN ONLINE DAILY WORKER I.B.L.'
    };
    
    const defaultConfig = { ...config };
    
    // Detect iOS device
    function isIOSDevice() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    
    // ==================== UTILITIES ====================
    function getTimezoneInfo() {
      const offset = new Date().getTimezoneOffset();
      const offsetHours = -offset / 60;
      
      if (offsetHours >= 9) {
        return { name: 'WIT', offset: 9 };
      } else if (offsetHours >= 8) {
        return { name: 'WITA', offset: 8 };
      } else {
        return { name: 'WIB', offset: 7 };
      }
    }
    
    function getLocalTime() {
      return new Date();
    }
    
    function formatDate(date) {
      const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      return `${days[date.getDay()]}, ${date.getDate()} ${months[date.getMonth()]} ${date.getFullYear()}`;
    }
    
    function formatTime(date) {
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
    }
    
    function formatTimeWithSeconds(date) {
      return date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    }
    
    function formatDateKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    
    function getInitials(name) {
      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    }
    
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }
    
    // ==================== STORAGE ====================
    function getData() {
      try {
        const data = localStorage.getItem(STORAGE_KEY);
        return data ? JSON.parse(data) : [];
      } catch (e) {
        return [];
      }
    }
    
    function saveData(records) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(records));
    }
    
    function addRecords(newRecords) {
      const existing = getData();
      saveData([...existing, ...newRecords]);
    }
    
    function getDataByDate(dateKey) {
      return getData().filter(r => r.date === dateKey);
    }
    
    function getDatesWithData() {
      const data = getData();
      return [...new Set(data.map(r => r.date))];
    }
    
    function getDatesWithPhotos() {
      const data = getData();
      return [...new Set(data.filter(r => r.photo_data).map(r => r.date))];
    }
    
    function getLastUpdateTime(dateKey) {
      const data = getDataByDate(dateKey);
      if (data.length === 0) return 'Belum ada data';
      
      const lastRecord = data.reduce((latest, record) => {
        return record.submitted_at > (latest.submitted_at || 0) ? record : latest;
      }, {});
      
      if (lastRecord.submitted_at) {
        const updateDate = new Date(lastRecord.submitted_at);
        return `${formatDate(updateDate)} - ${formatTimeWithSeconds(updateDate)}`;
      }
      
      return lastRecord.time || 'Tidak diketahui';
    }
    
    // ==================== TOAST ====================
    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const colors = {
        success: 'bg-emerald-500',
        error: 'bg-red-500',
        warning: 'bg-amber-500',
        info: 'bg-blue-500'
      };
      
      const toast = document.createElement('div');
      toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-2xl font-medium flex items-center gap-2`;
      toast.style.animation = 'slideDown 0.3s ease-out forwards';
      
      toast.innerHTML = `<span>${message}</span>`;
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateY(-20px)';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // ==================== SVG ICONS ====================
    const ICONS = {
      check: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>`,
      reset: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>`,
      recap: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>`,
      camera: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"/><circle cx="12" cy="13" r="3"/></svg>`,
      send: `<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 19V5m0 0l-7 7m7-7l7 7"/></svg>`,
      calendar: `<svg class="w-12 h-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5"/></svg>`,
      calendarSelect: `<svg class="w-12 h-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z"/></svg>`,
      photo: `<svg class="w-12 h-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>`,
      back: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>`,
      folder: `<svg class="w-12 h-12" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12.75V12A2.25 2.25 0 014.5 9.75h15A2.25 2.25 0 0121.75 12v.75m-8.69-6.44l-2.12-2.12a1.5 1.5 0 00-1.061-.44H4.5A2.25 2.25 0 002.25 6v12a2.25 2.25 0 002.25 2.25h15A2.25 2.25 0 0021.75 18V9a2.25 2.25 0 00-2.25-2.25h-5.379a1.5 1.5 0 01-1.06-.44z"/></svg>`,
      image: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>`,
      users: `<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/></svg>`,
      chartBar: `<svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>`,
      home: `<svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>`
    };
    
    // ==================== RENDER FUNCTIONS ====================
    function render() {
      const app = document.getElementById('app');
      
      switch(state.currentPage) {
        case 'login':
          app.innerHTML = renderLogin();
          break;
        case 'attendance':
          app.innerHTML = renderAttendance();
          startClock();
          break;
        case 'recap-menu':
          app.innerHTML = renderRecapMenu();
          break;
        case 'recap-today':
        case 'recap-date':
          app.innerHTML = renderRecap();
          break;
        case 'calendar':
          app.innerHTML = renderCalendar();
          break;
        case 'gallery':
          app.innerHTML = renderGallery();
          break;
        case 'gallery-date':
          app.innerHTML = renderGalleryDate();
          break;
      }
    }
    
    // ==================== LOGIN PAGE ====================
    function renderLogin() {
      return `
        <div class="min-h-full flex items-center justify-center p-4">
          <div class="bg-white rounded-3xl p-8 w-full max-w-md shadow-2xl">
            <div class="text-center mb-8">
              <img src="https://lh3.googleusercontent.com/d/10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw" 
                   alt="Logo" class="h-28 mx-auto object-contain" style="margin-bottom: 10px;"
                   onerror="this.src=''; this.alt='Logo'; this.className='text-8xl'; this.style.marginBottom='10px';">
              <h1 class="text-2xl font-bold text-slate-800 uppercase tracking-wide">Archipelago Daily Worker</h1>
            </div>
            
            <form id="login-form" class="space-y-4">
              <div>
                <label for="username" class="block text-sm font-medium text-slate-600 mb-2">Username</label>
                <input type="text" id="username" name="username"
                       class="w-full px-4 py-3 rounded-xl bg-slate-100 border border-slate-200 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400 transition"
                       placeholder="Masukkan username">
              </div>
              
              <div>
                <label for="password" class="block text-sm font-medium text-slate-600 mb-2">Password</label>
                <input type="password" id="password" name="password"
                       class="w-full px-4 py-3 rounded-xl bg-slate-100 border border-slate-200 text-slate-800 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-emerald-400 transition"
                       placeholder="Masukkan password">
              </div>
              
              <div id="login-error" class="hidden bg-red-500/20 border border-red-400 text-red-600 px-4 py-2 rounded-xl text-sm"></div>
              
              <button type="submit" class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold rounded-xl shadow-lg hover:shadow-xl transition transform hover:scale-[1.02]">
                Login
              </button>
            </form>
          </div>
        </div>
      `;
    }
    
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const errorDiv = document.getElementById('login-error');
      
      if (username === CREDENTIALS.username && password === CREDENTIALS.password) {
        state.isLoggedIn = true;
        state.currentPage = 'attendance';
        render();
        showToast('Login berhasil! Selamat datang', 'success');
      } else {
        errorDiv.textContent = 'Username atau password salah!';
        errorDiv.classList.remove('hidden');
      }
    }
    
    // ==================== HEADER COMPONENT ====================
    function renderHeader(showBackButton = false) {
      const localTime = getLocalTime();
      const tz = getTimezoneInfo();
      
      return `
        <header class="bg-gradient-to-r from-slate-800 to-slate-900 text-white p-4 shadow-xl sticky top-0 z-40">
          <div class="max-w-7xl mx-auto">
            <div class="flex items-center justify-between flex-wrap gap-4">
              <div class="flex items-center gap-3">
                <img src="https://lh3.googleusercontent.com/d/10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw" 
                     alt="Logo" class="h-10 object-contain logo-white"
                     onerror="this.style.display='none';">
                <h1 class="text-2xl font-bold uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
              </div>
              
              <div class="flex items-center gap-6">
                <div class="text-right">
                  <p class="text-sm text-blue-200">${formatDate(localTime)}</p>
                  <div class="flex items-center justify-end gap-3">
                    <span id="live-clock" class="text-2xl font-bold font-mono text-yellow-400">${formatTimeWithSeconds(localTime)}</span>
                    <span class="text-2xl font-bold font-mono text-yellow-400">${tz.name}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </header>
        ${showBackButton ? `
        <div class="bg-slate-700/50 backdrop-blur-sm py-3 px-4 sticky top-[72px] z-30">
          <div class="max-w-7xl mx-auto flex justify-end gap-3">
            <button onclick="goBack()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2 text-white">
              ${ICONS.back} Back
            </button>
            <button onclick="goToAttendance()" class="bg-emerald-600 hover:bg-emerald-700 px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2 text-white">
              ${ICONS.home} Back to Home
            </button>
          </div>
        </div>
        ` : ''}
      `;
    }
    
    // ==================== ATTENDANCE PAGE ====================
    function renderAttendance() {
      const selectedCount = Object.keys(state.selectedWorkers).length;
      const remainingCount = WORKERS.length - selectedCount;
      
      const filteredWorkers = WORKERS.filter(w => 
        w.toLowerCase().includes(state.searchQuery.toLowerCase())
      );
      
      return `
        <div class="min-h-full dark-blue-bg">
          ${renderHeader()}
          
          <div class="max-w-7xl mx-auto p-4">
            <!-- Action Buttons Row -->
            <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
              <div class="flex flex-wrap gap-3">
                <button onclick="selectAllPresent()" class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2 shadow-lg">
                  ${ICONS.check} Hadir Semua
                </button>
                <button onclick="resetAll()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2 shadow-lg">
                  ${ICONS.reset} Reset Semua
                </button>
              </div>
              
              <button onclick="goToRecapMenu()" class="bg-indigo-600 hover:bg-indigo-700 px-4 py-2 rounded-xl font-semibold transition flex items-center gap-2 text-white shadow-lg">
                ${ICONS.recap} Recap Absen
              </button>
            </div>
            
            <!-- Search & Counter Row -->
            <div class="flex flex-wrap items-center gap-4 mb-6">
              <div class="flex-1 min-w-0">
                <div class="relative w-full">
                <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                <input type="text" id="search-input" placeholder="Cari nama pekerja..."
                       oninput="handleSearchDebounce(this.value)"
                       class="w-full pl-10 pr-4 py-3 rounded-xl border-2 border-slate-200 focus:border-blue-500 focus:outline-none transition shadow-sm">
              </div>
              </div>
              
              <div class="flex items-center gap-3 bg-white px-4 py-3 rounded-xl shadow-sm border-2 border-slate-200 shrink-0">
                <span class="flex items-center gap-1 text-emerald-600 font-semibold">
                  ${selectedCount} Dipilih
                </span>
                <span class="text-slate-300">|</span>
                <span class="flex items-center gap-1 text-red-500 font-semibold">
                  ${remainingCount} Belum
                </span>
              </div>
            </div>
            
            <!-- Worker Cards Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 mb-6">
              ${filteredWorkers.map((worker, i) => renderWorkerCard(worker, i)).join('')}
            </div>
            
            <!-- Photo Upload Section -->
            <div class="glass-card rounded-2xl p-6 mb-6 shadow-xl">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                ${ICONS.image} Upload Foto Absensi
              </h3>
              
              <div class="flex flex-wrap gap-3 mb-4">
                <label class="bg-slate-800 hover:bg-slate-900 text-white px-6 py-3 rounded-xl font-semibold transition flex items-center gap-2 cursor-pointer shadow-lg">
                  ${ICONS.camera} Upload Foto
                  <input type="file" accept="image/*" multiple capture="environment" onchange="handleFileUpload(event)" class="hidden">
                </label>
              </div>
              
              <!-- Photo Previews -->
              <div id="photo-preview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                ${state.photos.map((photo, i) => `
                  <div class="relative group">
                    <img src="${photo}" class="w-full aspect-square object-cover rounded-xl shadow cursor-pointer hover:opacity-90 transition" onclick="openPhotoPreview(${i})">
                    <button onclick="event.stopPropagation(); removePhoto(${i})" 
                            class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-sm font-bold">
                      √ó
                    </button>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <!-- Submit Button -->
            <button onclick="submitAttendance()" 
                    id="submit-btn"
                    ${state.isSubmitting ? 'disabled' : ''}
                    class="w-full py-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold text-xl rounded-2xl shadow-2xl hover:shadow-xl transition transform hover:scale-[1.01] disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-3">
              ${state.isSubmitting ? '<span class="animate-spin">‚è≥</span> Mengirim...' : `${ICONS.send} Kirim Absensi`}
            </button>
          </div>
        </div>
        
        <!-- Photo Preview Modal -->
        <div id="photo-preview-modal" class="fixed inset-0 bg-black/90 z-50 hidden items-center justify-center p-4" onclick="closePhotoPreview()">
          <div class="relative max-w-4xl w-full max-h-[90%] flex flex-col items-center">
            <button onclick="closePhotoPreview()" class="absolute top-2 right-2 bg-white/20 hover:bg-white/40 text-white w-10 h-10 rounded-full flex items-center justify-center text-2xl font-bold z-10 transition">
              √ó
            </button>
            <img id="photo-preview-image" class="max-w-full max-h-[85%] object-contain rounded-xl shadow-2xl" alt="Preview foto" onclick="event.stopPropagation()">
          </div>
        </div>
      `;
    }
    
    function renderWorkerCard(worker, index) {
      const selected = state.selectedWorkers[worker];
      const isSelected = !!selected;
      
      return `
        <div class="worker-card ${isSelected ? 'selected' : 'glass-card'} rounded-2xl p-4 shadow-lg" style="animation-delay: ${index * 0.02}s">
          <div class="flex flex-col items-center text-center">
            <div class="w-14 h-14 rounded-full ${isSelected ? 'bg-white/30' : 'bg-gradient-to-br from-blue-500 to-indigo-600'} flex items-center justify-center text-white font-bold text-lg mb-2 shadow">
              ${getInitials(worker)}
            </div>
            <h4 class="font-semibold text-sm ${isSelected ? 'text-white' : 'text-slate-800'} mb-3 line-clamp-2">${worker}</h4>
            
            <div class="grid grid-cols-2 gap-1.5 w-full">
              ${STATUSES.map(status => {
                const colors = STATUS_COLORS[status];
                const isActive = selected?.status === status;
                return `
                  <button onclick="toggleWorkerStatus('${worker}', '${status}')"
                          class="status-btn ${colors.bg} ${colors.hover} text-white text-xs py-1.5 px-2 rounded-lg font-medium ${isActive ? 'ring-2 ring-offset-1 ring-white' : 'opacity-80'}">
                    ${status === 'Start Work' ? 'Start' : status === 'Finish Work' ? 'Finish' : status}
                  </button>
                `;
              }).join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    function toggleWorkerStatus(worker, status) {
      if (state.selectedWorkers[worker]?.status === status) {
        delete state.selectedWorkers[worker];
      } else {
        state.selectedWorkers[worker] = { status, time: getLocalTime() };
      }
      
      if (state.searchQuery !== '') {
        state.searchQuery = '';
        render();
      } else {
        updateWorkerCard(worker);
        updateCounters();
      }
    }
    
    function updateWorkerCard(worker) {
      const cards = document.querySelectorAll('.worker-card');
      const workerIndex = WORKERS.indexOf(worker);
      if (workerIndex === -1) return;
      
      const filteredWorkers = WORKERS.filter(w => 
        w.toLowerCase().includes(state.searchQuery.toLowerCase())
      );
      const filteredIndex = filteredWorkers.indexOf(worker);
      if (filteredIndex === -1) return;
      
      const card = cards[filteredIndex];
      if (!card) return;
      
      const selected = state.selectedWorkers[worker];
      const isSelected = !!selected;
      
      if (isSelected) {
        card.classList.add('selected');
        card.classList.remove('glass-card');
      } else {
        card.classList.remove('selected');
        card.classList.add('glass-card');
      }
      
      const buttons = card.querySelectorAll('.status-btn');
      buttons.forEach((btn, i) => {
        const status = STATUSES[i];
        const isActive = selected?.status === status;
        if (isActive) {
          btn.classList.add('ring-2', 'ring-offset-1', 'ring-white');
          btn.classList.remove('opacity-80');
        } else {
          btn.classList.remove('ring-2', 'ring-offset-1', 'ring-white');
          btn.classList.add('opacity-80');
        }
      });
    }
    
    function updateCounters() {
      const selectedCount = Object.keys(state.selectedWorkers).length;
      const remainingCount = WORKERS.length - selectedCount;
      
      const counterDiv = document.querySelector('.bg-white.px-4.py-2.rounded-xl.shadow-sm.border');
      if (counterDiv) {
        counterDiv.innerHTML = `
          <span class="flex items-center gap-1 text-emerald-600 font-semibold">
            ${selectedCount} Dipilih
          </span>
          <span class="text-slate-300">|</span>
          <span class="flex items-center gap-1 text-red-500 font-semibold">
            ${remainingCount} Belum
          </span>
        `;
      }
    }
    
    function selectAllPresent() {
      const time = getLocalTime();
      WORKERS.forEach(worker => {
        state.selectedWorkers[worker] = { status: 'Start Work', time };
      });
      render();
      showToast('Semua pekerja ditandai hadir!', 'success');
    }
    
    function resetAll() {
      state.selectedWorkers = {};
      state.photos = [];
      state.photosFullRes = [];
      render();
      showToast('Semua pilihan direset!', 'info');
    }
    
    function handleSearchDebounce(query) {
      state.searchQuery = query;
      updateWorkerGrid();
    }
    
    function updateWorkerGrid() {
      const filteredWorkers = WORKERS.filter(w => 
        w.toLowerCase().includes(state.searchQuery.toLowerCase())
      );
      
      const gridContainer = document.querySelector('.grid.grid-cols-2.sm\\:grid-cols-3.md\\:grid-cols-4.lg\\:grid-cols-5.xl\\:grid-cols-6');
      if (gridContainer) {
        gridContainer.innerHTML = filteredWorkers.map((worker, i) => renderWorkerCard(worker, i)).join('');
      }
    }
    
    // ==================== LOCATION HANDLING ====================
    let currentLocation = { address: 'Lokasi belum tersedia' };
    let locationReady = false;
    
    function getLocationBeforePhoto() {
      return new Promise((resolve) => {
        if (!navigator.geolocation) {
          currentLocation = { address: 'GPS tidak didukung' };
          resolve();
          return;
        }
        
        const timeout = setTimeout(() => {
          if (!locationReady) {
            currentLocation.address = 'Lokasi tidak tersedia (timeout)';
          }
          resolve();
        }, 15000);
        
        navigator.geolocation.getCurrentPosition(
          async (position) => {
            clearTimeout(timeout);
            
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            currentLocation = {
              lat: lat,
              lng: lng,
              address: `${lat.toFixed(6)}, ${lng.toFixed(6)}`
            };
            
            try {
              const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1&zoom=18`);
              const data = await response.json();
              
              if (data && data.display_name) {
                currentLocation.address = data.display_name;
              }
            } catch (err) {
              console.log('Geocoding error, using coordinates');
            }
            
            locationReady = true;
            resolve();
          },
          (error) => {
            clearTimeout(timeout);
            
            let errorMsg = 'Lokasi tidak tersedia';
            switch(error.code) {
              case 1:
                errorMsg = 'Izin lokasi ditolak';
                break;
              case 2:
                errorMsg = 'Lokasi tidak tersedia';
                break;
              case 3:
                errorMsg = 'Timeout mendapatkan lokasi';
                break;
            }
            
            currentLocation = { address: errorMsg };
            resolve();
          },
          { 
            enableHighAccuracy: true, 
            timeout: 12000, 
            maximumAge: 0 
          }
        );
      });
    }
    
    // Logo image for watermark
    let logoImage = null;
    const logoUrl = 'https://lh3.googleusercontent.com/d/1zaavYZSem-yNHztE724qeIAWw9uGJgen=s1024';
    
    function loadLogoImage() {
      return new Promise((resolve) => {
        if (logoImage) {
          resolve(logoImage);
          return;
        }
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          logoImage = img;
          resolve(img);
        };
        img.onerror = () => {
          resolve(null);
        };
        img.src = logoUrl;
      });
    }
    
    loadLogoImage();
    
    // ==================== PHOTO UPLOAD WITH DUAL RESOLUTION ====================
    async function handleFileUpload(event) {
      const files = event.target.files;
      if (files.length === 0) return;
      
      locationReady = false;
      await getLocationBeforePhoto();
      
      pendingFiles = Array.from(files);
      photoQueue = [];
      photoQueueFullRes = [];
      currentPreviewIndex = 0;
      
      await processNextPhoto();
      
      event.target.value = '';
    }
    
    async function processNextPhoto() {
      if (currentPreviewIndex >= pendingFiles.length) {
        closeConfirmModal();
        return;
      }
      
      const file = pendingFiles[currentPreviewIndex];
      
      try {
        const { preview, fullRes } = await processImageDualResolution(file);
        photoQueue[currentPreviewIndex] = preview;
        photoQueueFullRes[currentPreviewIndex] = fullRes;
        
        showPhotoConfirmModal(preview);
      } catch (err) {
        console.error('Error processing image:', err);
        showToast('Gagal memproses foto', 'error');
        currentPreviewIndex++;
        await processNextPhoto();
      }
    }
    
    // ==================== DUAL RESOLUTION PROCESSING ====================
    function processImageDualResolution(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = (e) => {
          const img = new Image();
          
          img.onload = () => {
            // Create PREVIEW (small - max 480px)
            const previewCanvas = document.createElement('canvas');
            const previewCtx = previewCanvas.getContext('2d');
            
            const previewMaxSize = 480;
            let previewWidth = img.width;
            let previewHeight = img.height;
            
            if (previewWidth > previewHeight) {
              if (previewWidth > previewMaxSize) {
                previewHeight = (previewHeight * previewMaxSize) / previewWidth;
                previewWidth = previewMaxSize;
              }
            } else {
              if (previewHeight > previewMaxSize) {
                previewWidth = (previewWidth * previewMaxSize) / previewHeight;
                previewHeight = previewMaxSize;
              }
            }
            
            previewCanvas.width = previewWidth;
            previewCanvas.height = previewHeight;
            previewCtx.drawImage(img, 0, 0, previewWidth, previewHeight);
            addWatermark(previewCtx, previewWidth, previewHeight);
            const preview = previewCanvas.toDataURL('image/jpeg', 0.6);
            
            // Create FULL RESOLUTION (original size or max 1920px)
            const fullCanvas = document.createElement('canvas');
            const fullCtx = fullCanvas.getContext('2d');
            
            const fullMaxSize = 1920;
            let fullWidth = img.width;
            let fullHeight = img.height;
            
            if (fullWidth > fullMaxSize || fullHeight > fullMaxSize) {
              if (fullWidth > fullHeight) {
                fullHeight = (fullHeight * fullMaxSize) / fullWidth;
                fullWidth = fullMaxSize;
              } else {
                fullWidth = (fullWidth * fullMaxSize) / fullHeight;
                fullHeight = fullMaxSize;
              }
            }
            
            fullCanvas.width = fullWidth;
            fullCanvas.height = fullHeight;
            fullCtx.drawImage(img, 0, 0, fullWidth, fullHeight);
            addWatermark(fullCtx, fullWidth, fullHeight);
            const fullRes = fullCanvas.toDataURL('image/jpeg', 0.92);
            
            resolve({ preview, fullRes });
          };
          
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };
        
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }
    
    function showPhotoConfirmModal(photoData) {
      const modal = document.getElementById('photo-confirm-modal');
      const img = document.getElementById('confirm-preview-image');
      const counter = document.getElementById('photo-counter');
      
      img.src = photoData;
      counter.textContent = `Foto ${currentPreviewIndex + 1} dari ${pendingFiles.length}`;
      
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function closeConfirmModal() {
      const modal = document.getElementById('photo-confirm-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      
      pendingFiles = [];
      photoQueue = [];
      photoQueueFullRes = [];
      currentPreviewIndex = 0;
    }
    
    // ==================== CONFIRM PHOTO ====================
    async function confirmPhoto() {
      const preview = photoQueue[currentPreviewIndex];
      const fullRes = photoQueueFullRes[currentPreviewIndex];
      
      if (!preview || !fullRes) {
        currentPreviewIndex++;
        processNextPhoto();
        return;
      }
      
      state.photos.push(preview);
      state.photosFullRes.push(fullRes);
      updatePhotoGrid();
      
      if (isIOSDevice()) {
        showToast('Foto ditambahkan! Akan tersimpan saat kirim absensi', 'success');
        currentPreviewIndex++;
        processNextPhoto();
      } else {
        savePhotoToGallery(fullRes);
        showToast('Foto ditambahkan & disimpan ke galeri!', 'success');
        currentPreviewIndex++;
        processNextPhoto();
      }
    }
    
    // ==================== AUTO DOWNLOAD FOR ANDROID/DESKTOP ====================
    function savePhotoToGallery(photoData) {
      try {
        const link = document.createElement('a');
        
        const now = new Date();
        const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}`;
        const filename = `Absen_IBL_${timestamp}.jpg`;
        
        link.href = photoData;
        link.download = filename;
        
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      } catch (err) {
        console.log('Could not save to gallery:', err);
      }
    }
    
    function retakePhoto() {
      const modal = document.getElementById('photo-confirm-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      
      pendingFiles = [];
      photoQueue = [];
      photoQueueFullRes = [];
      currentPreviewIndex = 0;
      
      const fileInput = document.querySelector('input[type="file"][accept="image/*"]');
      if (fileInput) {
        fileInput.click();
      }
    }
    
    function updatePhotoGrid() {
      const photoPreview = document.getElementById('photo-preview');
      if (photoPreview) {
        photoPreview.innerHTML = state.photos.map((photo, i) => `
          <div class="relative group">
            <img src="${photo}" class="w-full aspect-square object-cover rounded-xl shadow cursor-pointer hover:opacity-90 transition" onclick="openPhotoPreview(${i})">
            <button onclick="event.stopPropagation(); removePhoto(${i})" 
                    class="absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-sm font-bold">
              √ó
            </button>
          </div>
        `).join('');
      }
    }
    
    function addWatermark(ctx, width, height) {
      const now = getLocalTime();
      
      const isLandscape = width > height;
      
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const timeStr = `${hours}:${minutes}`;
      
      const days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'Mei', 'Jun', 'Jul', 'Agu', 'Sep', 'Okt', 'Nov', 'Des'];
      const dateStr = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
      const dayStr = days[now.getDay()];
      
      const locationStr = currentLocation?.address || 'Lokasi tidak tersedia';
      
      const shortSide = Math.min(width, height);
      const scale = shortSide / 720;
      
      const padding = 20 * scale;
      const maxLocationWidth = (width / 2) - padding;
      
      ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
      ctx.shadowBlur = 4 * scale;
      ctx.shadowOffsetX = 1 * scale;
      ctx.shadowOffsetY = 1 * scale;
      
      const timeMarkSize = 21 * scale;
      ctx.font = `bold ${timeMarkSize}px Arial, sans-serif`;
      ctx.textAlign = 'right';
      
      const markText = 'Mark';
      const timeText = 'Time';
      const markWidth = ctx.measureText(markText).width;
      
      ctx.fillStyle = '#FFFFFF';
      ctx.fillText(markText, width - padding, padding + timeMarkSize);
      
      ctx.fillStyle = '#F97316';
      ctx.fillText(timeText, width - padding - markWidth, padding + timeMarkSize);
      
      ctx.textAlign = 'left';
      
      const locationSize = 18 * scale;
      const daySize = 21 * scale;
      const dateSize = 21 * scale;
      const timeSize = isLandscape ? 42 * scale : 48 * scale;
      const logoSize = isLandscape ? 68 * scale : 82 * scale;
      const lineGap = 9 * scale;
      
      ctx.font = `${locationSize}px Arial, sans-serif`;
      const locationLines = wrapText(ctx, 'üìç ' + locationStr, maxLocationWidth);
      
      let currentY = height - padding;
      
      ctx.font = `${locationSize}px Arial, sans-serif`;
      ctx.fillStyle = '#FFFFFF';
      for (let i = locationLines.length - 1; i >= 0; i--) {
        ctx.fillText(locationLines[i], padding, currentY);
        currentY -= (locationSize + 3 * scale);
      }
      currentY -= lineGap;
      
      ctx.font = `${dateSize}px Arial, sans-serif`;
      ctx.fillText(dateStr, padding, currentY);
      currentY -= (dateSize + lineGap);
      
      ctx.font = `bold ${daySize}px Arial, sans-serif`;
      ctx.fillText(dayStr, padding, currentY);
      currentY -= (daySize + lineGap);
      
      ctx.font = `bold ${timeSize}px Arial, sans-serif`;
      ctx.fillText(timeStr, padding, currentY);
      currentY -= (timeSize + lineGap);
      
      const logoY = currentY - logoSize;
      const logoX = padding;
      const logoRadius = 8 * scale;
      
      if (logoImage) {
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 6 * scale;
        
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(logoX + logoRadius, logoY);
        ctx.lineTo(logoX + logoSize - logoRadius, logoY);
        ctx.quadraticCurveTo(logoX + logoSize, logoY, logoX + logoSize, logoY + logoRadius);
        ctx.lineTo(logoX + logoSize, logoY + logoSize - logoRadius);
        ctx.quadraticCurveTo(logoX + logoSize, logoY + logoSize, logoX + logoSize - logoRadius, logoY + logoSize);
        ctx.lineTo(logoX + logoRadius, logoY + logoSize);
        ctx.quadraticCurveTo(logoX, logoY + logoSize, logoX, logoY + logoSize - logoRadius);
        ctx.lineTo(logoX, logoY + logoRadius);
        ctx.quadraticCurveTo(logoX, logoY, logoX + logoRadius, logoY);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(logoImage, logoX, logoY, logoSize, logoSize);
        ctx.restore();
      } else {
        ctx.shadowColor = 'rgba(0, 0, 0, 0.3)';
        ctx.shadowBlur = 6 * scale;
        ctx.fillStyle = '#FFFFFF';
        ctx.beginPath();
        ctx.moveTo(logoX + logoRadius, logoY);
        ctx.lineTo(logoX + logoSize - logoRadius, logoY);
        ctx.quadraticCurveTo(logoX + logoSize, logoY, logoX + logoSize, logoY + logoRadius);
        ctx.lineTo(logoX + logoSize, logoY + logoSize - logoRadius);
        ctx.quadraticCurveTo(logoX + logoSize, logoY + logoSize, logoX + logoSize - logoRadius, logoY + logoSize);
        ctx.lineTo(logoX + logoRadius, logoY + logoSize);
        ctx.quadraticCurveTo(logoX, logoY + logoSize, logoX, logoY + logoSize - logoRadius);
        ctx.lineTo(logoX, logoY + logoRadius);
        ctx.quadraticCurveTo(logoX, logoY, logoX + logoRadius, logoY);
        ctx.closePath();
        ctx.fill();
        
        ctx.shadowColor = 'transparent';
        ctx.fillStyle = '#000000';
        ctx.font = `bold ${18 * scale}px Arial, sans-serif`;
        ctx.textAlign = 'center';
        ctx.fillText('I.B.L.', logoX + logoSize / 2, logoY + logoSize / 2 + 6 * scale);
        ctx.textAlign = 'left';
      }
      
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
    }
    
    function wrapText(ctx, text, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';
      
      words.forEach(word => {
        const testLine = currentLine ? currentLine + ' ' + word : word;
        const metrics = ctx.measureText(testLine);
        
        if (metrics.width > maxWidth && currentLine) {
          lines.push(currentLine);
          currentLine = word;
        } else {
          currentLine = testLine;
        }
      });
      
      if (currentLine) {
        lines.push(currentLine);
      }
      
      return lines;
    }
    
    function removePhoto(index) {
      state.photos.splice(index, 1);
      state.photosFullRes.splice(index, 1);
      render();
    }
    
    function openPhotoPreview(index) {
      const modal = document.getElementById('photo-preview-modal');
      const img = document.getElementById('photo-preview-image');
      
      if (state.photosFullRes[index]) {
        img.src = state.photosFullRes[index];
      } else if (state.photos[index]) {
        img.src = state.photos[index];
      }
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function closePhotoPreview() {
      const modal = document.getElementById('photo-preview-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }
    
    // ==================== SUBMIT ====================
    async function submitAttendance() {
      const selectedCount = Object.keys(state.selectedWorkers).length;
      
      if (selectedCount === 0) {
        showToast('Pilih minimal 1 pekerja!', 'warning');
        return;
      }
      
      state.isSubmitting = true;
      render();
      
      const photosFullResToSave = [...state.photosFullRes];
      
      const localTime = getLocalTime();
      const dateKey = formatDateKey(localTime);
      const timeStr = formatTime(localTime);
      const tz = getTimezoneInfo();
      
      const records = Object.entries(state.selectedWorkers).map(([worker, data], i) => ({
        id: generateId(),
        date: dateKey,
        time: timeStr,
        timezone: tz.name,
        worker_name: worker,
        status: data.status,
        photo_data: state.photos[i] || null,
        submitted_at: Date.now()
      }));
      
      if (state.photos.length > Object.keys(state.selectedWorkers).length) {
        for (let i = Object.keys(state.selectedWorkers).length; i < state.photos.length; i++) {
          records.push({
            id: generateId(),
            date: dateKey,
            time: timeStr,
            timezone: tz.name,
            worker_name: 'Foto Tambahan',
            status: 'Photo Only',
            photo_data: state.photos[i],
            submitted_at: Date.now()
          });
        }
      }
      
      addRecords(records);
      
      const submittedCount = selectedCount;
      state.selectedWorkers = {};
      state.photos = [];
      state.photosFullRes = [];
      state.isSubmitting = false;
      render();
      
      showSuccessPopup(submittedCount);
      
      // iOS: Auto share photos via Share Sheet (no manual save modal)
      if (isIOSDevice() && photosFullResToSave.length > 0) {
        setTimeout(() => {
          savePhotosToGalleryIOS(photosFullResToSave);
        }, 800);
      }
    }
    
    // ==================== SAVE PHOTOS FOR iPHONE ====================
    async function savePhotosToGalleryIOS(photos) {
      if (photos.length === 0) return;
      
      const files = [];
      for (let i = 0; i < photos.length; i++) {
        try {
          const response = await fetch(photos[i]);
          const blob = await response.blob();
          
          const now = new Date();
          const timestamp = `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}_${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}${String(now.getSeconds()).padStart(2,'0')}_${i+1}`;
          const fileName = `Absen_IBL_${timestamp}.jpg`;
          
          const file = new File([blob], fileName, { type: 'image/jpeg' });
          files.push(file);
        } catch (err) {
          console.log('Error converting photo:', err);
        }
      }
      
      if (files.length === 0) return;
      
      if (navigator.canShare && navigator.canShare({ files })) {
        try {
          await navigator.share({
            files: files,
            title: 'Foto Absensi IBL',
            text: `${files.length} foto absensi - Tap "Save Image" untuk simpan ke galeri`
          });
          
          showToast('‚úÖ Foto berhasil disimpan!', 'success');
        } catch (err) {
          // User cancelled or share failed - no popup, just silent
          if (err.name !== 'AbortError') {
            console.log('Share failed:', err);
          }
        }
      }
    }
    
    function showSuccessPopup(count) {
      const popup = document.createElement('div');
      popup.id = 'success-popup';
      popup.className = 'fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4';
      popup.innerHTML = `
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl transform animate-bounce-in">
          <div class="w-20 h-20 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-emerald-500" fill="none" stroke="currentColor" stroke-width="3" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-slate-800 mb-3">Absensi Telah Dikirim!</h2>
          <p class="text-slate-600">${count} pekerja berhasil diabsen</p>
        </div>
      `;
      document.body.appendChild(popup);
      
      setTimeout(() => {
        popup.remove();
      }, 1000);
    }
    
    // ==================== CLOCK ====================
    function startClock() {
      setInterval(() => {
        const clockEl = document.getElementById('live-clock');
        if (clockEl) {
          clockEl.textContent = formatTimeWithSeconds(getLocalTime());
        }
      }, 1000);
    }
    
    // ==================== RECAP MENU ====================
    function goToRecapMenu() {
      state.currentPage = 'recap-menu';
      render();
    }
    
    function renderRecapMenu() {
      return `
        <div class="min-h-full dark-blue-bg">
          ${renderHeader(true)}
          
          <div class="max-w-4xl mx-auto p-4">
            <h1 class="text-3xl font-bold text-white mb-8 text-center">Menu Rekap Absensi</h1>
            
            <div class="grid md:grid-cols-3 gap-6">
              <button onclick="goToRecapToday()" class="navy-card p-8 rounded-2xl shadow-xl hover:shadow-2xl transition transform hover:scale-105 text-center group">
                <div class="text-white mb-4 flex justify-center group-hover:scale-110 transition">${ICONS.calendar}</div>
                <h3 class="text-xl font-bold text-white mb-2">Rekap Hari Ini</h3>
                <p class="text-blue-200 text-sm">Lihat rekap absensi hari ini</p>
              </button>
              
              <button onclick="goToCalendar()" class="navy-card p-8 rounded-2xl shadow-xl hover:shadow-2xl transition transform hover:scale-105 text-center group">
                <div class="text-white mb-4 flex justify-center group-hover:scale-110 transition">${ICONS.calendarSelect}</div>
                <h3 class="text-xl font-bold text-white mb-2">Rekap Tanggal</h3>
                <p class="text-blue-200 text-sm">Pilih tanggal dari kalender</p>
              </button>
              
              <button onclick="goToGallery()" class="navy-card p-8 rounded-2xl shadow-xl hover:shadow-2xl transition transform hover:scale-105 text-center group">
                <div class="text-white mb-4 flex justify-center group-hover:scale-110 transition">${ICONS.photo}</div>
                <h3 class="text-xl font-bold text-white mb-2">Foto Absen</h3>
                <p class="text-blue-200 text-sm">Lihat galeri foto absensi</p>
              </button>
            </div>
          </div>
        </div>
      `;
    }
    
    // ==================== RECAP PAGE ====================
    function goToRecapToday() {
      state.selectedRecapDate = formatDateKey(getLocalTime());
      state.currentPage = 'recap-today';
      render();
    }
    
    function goToRecapDate(dateKey) {
      state.selectedRecapDate = dateKey;
      state.currentPage = 'recap-date';
      render();
    }
    
    function renderRecap() {
      const dateKey = state.selectedRecapDate;
      const data = getDataByDate(dateKey);
      
      const [year, month, day] = dateKey.split('-');
      const dateObj = new Date(year, month - 1, day);
      
      const timeGroups = {};
      data.forEach(record => {
        if (!timeGroups[record.time]) timeGroups[record.time] = [];
        timeGroups[record.time].push(record);
      });
      
      const times = Object.keys(timeGroups).sort();
      
      const workerStatuses = {};
      data.forEach(record => {
        if (!workerStatuses[record.worker_name]) {
          workerStatuses[record.worker_name] = [];
        }
        workerStatuses[record.worker_name].push({ time: record.time, status: record.status });
      });
      
      const recordedWorkers = new Set(Object.keys(workerStatuses).filter(w => WORKERS.includes(w)));
      const totalRecorded = recordedWorkers.size;
      const notRecorded = WORKERS.length - totalRecorded;
      
      let startCount = 0, finishCount = 0, sakitCount = 0, standbyCount = 0;
      data.forEach(r => {
        if (r.status === 'Start Work') startCount++;
        if (r.status === 'Finish Work') finishCount++;
        if (r.status === 'Sakit') sakitCount++;
        if (r.status === 'Standby') standbyCount++;
      });
      
      const allWorkers = [...new Set([...WORKERS, ...Object.keys(workerStatuses)])];
      
      return `
        <div class="min-h-full dark-blue-bg">
          ${renderHeader(true)}
          
          <div class="max-w-7xl mx-auto p-4">
            <div class="text-center mb-8">
              <h1 class="text-3xl font-bold text-white mb-2 flex items-center justify-center gap-3">
                ${ICONS.chartBar} Rekap Absensi
              </h1>
              <p class="text-lg text-blue-200">${formatDate(dateObj)}</p>
            </div>
            
            <!-- Summary Cards -->
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
              <div class="bg-gradient-to-br from-slate-600 to-slate-800 text-white p-4 rounded-2xl shadow-lg text-center">
                <div class="text-3xl font-bold">${totalRecorded}/${WORKERS.length}</div>
                <div class="text-sm opacity-80">Total Terekap</div>
              </div>
              <div class="bg-gradient-to-br from-emerald-500 to-emerald-700 text-white p-4 rounded-2xl shadow-lg text-center">
                <div class="text-3xl font-bold">${startCount}</div>
                <div class="text-sm opacity-80">Start Work</div>
              </div>
              <div class="bg-gradient-to-br from-blue-500 to-blue-700 text-white p-4 rounded-2xl shadow-lg text-center">
                <div class="text-3xl font-bold">${finishCount}</div>
                <div class="text-sm opacity-80">Finish Work</div>
              </div>
              <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white p-4 rounded-2xl shadow-lg text-center">
                <div class="text-3xl font-bold">${standbyCount}</div>
                <div class="text-sm opacity-80">Standby</div>
              </div>
              <div class="bg-gradient-to-br from-orange-500 to-orange-700 text-white p-4 rounded-2xl shadow-lg text-center">
                <div class="text-3xl font-bold">${sakitCount}</div>
                <div class="text-sm opacity-80">Sakit</div>
              </div>
              <div class="bg-gradient-to-br from-red-500 to-red-700 text-white p-4 rounded-2xl shadow-lg text-center">
                <div class="text-3xl font-bold">${notRecorded}</div>
                <div class="text-sm opacity-80">Belum Absen</div>
              </div>
            </div>
            
            <!-- Recap Table -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
              <div class="flex justify-end px-4 py-2 bg-slate-100 border-b">
                <span class="text-sm text-slate-600 font-medium">
                  Update: ${getLastUpdateTime(dateKey)}
                </span>
              </div>
              <div class="overflow-x-auto">
                <table class="recap-table w-full">
                  <thead>
                    <tr class="bg-gradient-to-r from-slate-700 to-slate-800 text-white">
                      <th class="px-4 py-3 text-left font-semibold sticky left-0 bg-slate-800 z-10 min-w-[180px]">NAMA</th>
                      ${times.length > 0 ? times.map(t => `<th class="px-4 py-3 text-center font-semibold min-w-[120px]">${t}</th>`).join('') : '<th class="px-4 py-3 text-center font-semibold">Status</th>'}
                    </tr>
                  </thead>
                  <tbody>
                    ${allWorkers.map((worker, i) => {
                      const isResigned = !WORKERS.includes(worker);
                      const workerData = workerStatuses[worker];
                      const rowBg = i % 2 === 0 ? 'bg-white' : 'bg-blue-50';
                      
                      return `
                        <tr class="${rowBg} hover:bg-blue-100 transition">
                          <td class="px-4 py-3 font-medium sticky left-0 ${rowBg} z-10 border-r">
                            ${worker}
                            ${isResigned ? '<span class="ml-2 text-xs bg-red-100 text-red-600 px-2 py-0.5 rounded-full">(Resign)</span>' : ''}
                          </td>
                          ${times.length > 0 ? times.map(t => {
                            const record = timeGroups[t]?.find(r => r.worker_name === worker);
                            if (record) {
                              const badge = STATUS_COLORS[record.status]?.badge || 'badge-belum';
                              return `<td class="px-4 py-3 text-center"><span class="badge ${badge}">${record.status}</span></td>`;
                            }
                            return `<td class="px-4 py-3 text-center text-slate-400">-</td>`;
                          }).join('') : `<td class="px-4 py-3 text-center"><span class="badge badge-belum">Belum Absen</span></td>`}
                        </tr>
                      `;
                    }).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    // ==================== CALENDAR ====================
    function goToCalendar() {
      state.currentPage = 'calendar';
      render();
    }
    
    function renderCalendar() {
      const date = state.calendarDate;
      const year = date.getFullYear();
      const month = date.getMonth();
      
      const months = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                      'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      
      const datesWithData = getDatesWithData();
      const today = formatDateKey(getLocalTime());
      
      const days = [];
      for (let i = 0; i < firstDay; i++) {
        days.push('<div></div>');
      }
      
      for (let d = 1; d <= daysInMonth; d++) {
        const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
        const hasData = datesWithData.includes(dateKey);
        const isToday = dateKey === today;
        
        days.push(`
          <button onclick="goToRecapDate('${dateKey}')"
                  class="calendar-day w-full aspect-square rounded-xl flex items-center justify-center font-semibold text-lg
                         ${hasData ? 'has-data' : 'bg-white hover:bg-slate-100'}
                         ${isToday ? 'ring-4 ring-blue-500 ring-offset-2' : ''}
                         shadow transition">
            ${d}
          </button>
        `);
      }
      
      return `
        <div class="min-h-full dark-blue-bg">
          ${renderHeader(true)}
          
          <div class="max-w-2xl mx-auto p-4">
            <div class="glass-card rounded-2xl p-6 shadow-xl">
              <div class="flex items-center justify-between mb-6">
                <button onclick="prevMonth()" class="bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-xl font-bold transition">
                  Prev
                </button>
                <h2 class="text-2xl font-bold text-slate-800">${months[month]} ${year}</h2>
                <button onclick="nextMonth()" class="bg-slate-200 hover:bg-slate-300 px-4 py-2 rounded-xl font-bold transition">
                  Next
                </button>
              </div>
              
              <div class="grid grid-cols-7 gap-2 mb-4">
                ${['Min', 'Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab'].map(d => 
                  `<div class="text-center font-semibold text-slate-600 py-2">${d}</div>`
                ).join('')}
              </div>
              
              <div class="grid grid-cols-7 gap-2">
                ${days.join('')}
              </div>
              
              <div class="mt-6 flex items-center gap-4 text-sm text-slate-600">
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 rounded bg-emerald-500"></div>
                  <span>Ada Data</span>
                </div>
                <div class="flex items-center gap-2">
                  <div class="w-4 h-4 rounded bg-white border ring-2 ring-blue-500"></div>
                  <span>Hari Ini</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }
    
    function prevMonth() {
      state.calendarDate = new Date(state.calendarDate.getFullYear(), state.calendarDate.getMonth() - 1, 1);
      render();
    }
    
    function nextMonth() {
      state.calendarDate = new Date(state.calendarDate.getFullYear(), state.calendarDate.getMonth() + 1, 1);
      render();
    }
    
    // ==================== GALLERY ====================
    function goToGallery() {
      state.currentPage = 'gallery';
      render();
    }
    
    function renderGallery() {
      const datesWithPhotos = getDatesWithPhotos().sort().reverse();
      
      return `
        <div class="min-h-full dark-blue-bg">
          ${renderHeader(true)}
          
          <div class="max-w-4xl mx-auto p-4">
            <h1 class="text-3xl font-bold text-white mb-8 text-center flex items-center justify-center gap-3">
              ${ICONS.image} Galeri Foto Absensi
            </h1>
            
            ${datesWithPhotos.length === 0 ? `
              <div class="text-center py-16">
                <div class="text-white mb-4 flex justify-center">${ICONS.photo}</div>
                <p class="text-blue-200 text-lg">Belum ada foto absensi</p>
              </div>
            ` : `
              <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                ${datesWithPhotos.map(dateKey => {
                  const [year, month, day] = dateKey.split('-');
                  const photos = getData().filter(r => r.date === dateKey && r.photo_data);
                  
                  return `
                    <button onclick="goToGalleryDate('${dateKey}')" 
                            class="navy-card p-6 rounded-2xl shadow-lg hover:shadow-xl transition transform hover:scale-105 text-center group">
                      <div class="text-white mb-3 flex justify-center group-hover:scale-110 transition">${ICONS.folder}</div>
                      <h3 class="font-bold text-white mb-1">${day}/${month}/${year}</h3>
                      <p class="text-sm text-blue-200">${photos.length} foto</p>
                    </button>
                  `;
                }).join('')}
              </div>
            `}
          </div>
        </div>
      `;
    }
    
    function goToGalleryDate(dateKey) {
      state.selectedRecapDate = dateKey;
      state.currentPage = 'gallery-date';
      render();
    }
    
    function renderGalleryDate() {
      const dateKey = state.selectedRecapDate;
      const [year, month, day] = dateKey.split('-');
      const dateObj = new Date(year, month - 1, day);
      
      const photos = getData().filter(r => r.date === dateKey && r.photo_data);
      
      return `
        <div class="min-h-full dark-blue-bg">
          ${renderHeader(true)}
          
          <div class="max-w-6xl mx-auto p-4">
            <h1 class="text-3xl font-bold text-white mb-2 text-center flex items-center justify-center gap-3">
              ${ICONS.image} Foto Absensi
            </h1>
            <p class="text-lg text-blue-200 mb-8 text-center">${formatDate(dateObj)}</p>
            
            <div class="photo-grid grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
              ${photos.map((photo, index) => `
                <div class="cursor-pointer" onclick="openGalleryPreview(${index}, '${dateKey}')">
                  <img src="${photo.photo_data}" class="w-full aspect-square object-cover rounded-2xl shadow-lg hover:shadow-xl transition hover:scale-105">
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
    }
    
    // ==================== GALLERY FULL PREVIEW ====================
    function openGalleryPreview(index, dateKey) {
      const photos = getData().filter(r => r.date === dateKey && r.photo_data);
      galleryPhotos = photos.map(p => p.photo_data);
      galleryCurrentIndex = index;
      
      updateGalleryPreview();
      
      const modal = document.getElementById('gallery-preview-modal');
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }
    
    function updateGalleryPreview() {
      const img = document.getElementById('gallery-preview-image');
      const counter = document.getElementById('gallery-counter');
      const prevBtn = document.getElementById('gallery-prev-btn');
      const nextBtn = document.getElementById('gallery-next-btn');
      
      img.src = galleryPhotos[galleryCurrentIndex];
      counter.textContent = `${galleryCurrentIndex + 1} / ${galleryPhotos.length}`;
      
      // Show/hide nav buttons
      prevBtn.style.display = galleryCurrentIndex === 0 ? 'none' : 'flex';
      nextBtn.style.display = galleryCurrentIndex === galleryPhotos.length - 1 ? 'none' : 'flex';
    }
    
    function prevGalleryPhoto() {
      if (galleryCurrentIndex > 0) {
        galleryCurrentIndex--;
        updateGalleryPreview();
      }
    }
    
    function nextGalleryPhoto() {
      if (galleryCurrentIndex < galleryPhotos.length - 1) {
        galleryCurrentIndex++;
        updateGalleryPreview();
      }
    }
    
    function closeGalleryPreview() {
      const modal = document.getElementById('gallery-preview-modal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      galleryPhotos = [];
      galleryCurrentIndex = 0;
    }
    
    // ==================== NAVIGATION ====================
    function goToAttendance() {
      state.currentPage = 'attendance';
      render();
    }
    
    function goBack() {
      switch(state.currentPage) {
        case 'recap-today':
          state.currentPage = 'recap-menu';
          break;
        case 'recap-date':
          state.currentPage = 'calendar';
          break;
        case 'calendar':
          state.currentPage = 'recap-menu';
          break;
        case 'gallery':
          state.currentPage = 'recap-menu';
          break;
        case 'gallery-date':
          state.currentPage = 'gallery';
          break;
        case 'recap-menu':
          state.currentPage = 'attendance';
          break;
        default:
          state.currentPage = 'attendance';
      }
      render();
    }
    
    // ==================== ELEMENT SDK ====================
    const elementSdk = {
      init: async function(element) {
        if (window.elementSdk) {
          await window.elementSdk.init(element);
          config = window.elementSdk.config || defaultConfig;
        }
        render();
        attachEventListeners();
      }
    };
    
    function attachEventListeners() {
      document.addEventListener('submit', function(e) {
        if (e.target.id === 'login-form') {
          handleLogin(e);
        }
      });
      
      // Keyboard navigation for gallery preview
      document.addEventListener('keydown', function(e) {
        const modal = document.getElementById('gallery-preview-modal');
        if (modal && !modal.classList.contains('hidden')) {
          if (e.key === 'ArrowLeft') {
            prevGalleryPhoto();
          } else if (e.key === 'ArrowRight') {
            nextGalleryPhoto();
          } else if (e.key === 'Escape') {
            closeGalleryPreview();
          }
        }
      });
    }
    
    // Initialize
    elementSdk.init({
      defaultConfig,
      onConfigChange: async (newConfig) => {
        config = { ...config, ...newConfig };
        render();
      },
      mapToCapabilities: (cfg) => ({
        recolorables: [],
        borderables: [],
        fontEditable: undefined,
        fontSizeable: undefined
      }),
      mapToEditPanelValues: (cfg) => new Map([
        ['app_title', cfg.app_title || defaultConfig.app_title]
      ])
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b6b038ee0ede9d5',t:'MTc2NzE5NzA3OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
