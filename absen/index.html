<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absen Archipelago</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: flex;
    }
    
    .soft-navy-bg {
      background: #1e3a5f;
    }
    
    .darker-header {
      background: #0f2744;
    }
    
    .status-btn {
      transition: all 0.2s ease;
    }
    
    .status-btn:hover {
      transform: scale(1.05);
    }
    
    .status-btn.selected {
      font-weight: 700 !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: scale(1.05);
    }
    
    .worker-card.selected {
      background: #ff1493 !important;
      border: 3px solid #ff006a !important;
      box-shadow: 0 0 25px rgba(255, 20, 147, 0.7) !important;
    }
    
    .worker-card.selected .worker-name,
    .worker-card.selected .status-text {
      color: white !important;
      font-weight: 700 !important;
    }
    
    .clock-time {
      color: #f59e0b;
      font-weight: 700;
    }
    
    .calendar-day:hover {
      background: #3b82f6;
      color: white;
    }
    
    .calendar-day.has-data {
      background: #10b981;
      color: white;
    }
    
    .photo-folder {
      transition: all 0.3s ease;
    }
    
    .photo-folder:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .gallery-photo {
      transition: all 0.3s ease;
    }
    
    .gallery-photo:hover {
      transform: scale(1.05);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }
    
    .toast {
      animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    input[type="file"] {
      display: none;
    }
    
    .logo-white {
      filter: brightness(0) invert(1);
    }
    
    .logo-black {
      filter: brightness(0);
    }
    
    .worker-photo-img {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 3px solid #e5e7eb;
    }
    
    .worker-card.selected .worker-photo-img {
      border-color: white;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1e3a5f;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Camera styles */
    .camera-container {
      position: fixed;
      inset: 0;
      background: black;
      z-index: 100;
    }
    
    .camera-video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .camera-controls {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: white;
      border: 4px solid #f59e0b;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .capture-btn:hover {
      transform: scale(1.1);
    }
    
    .capture-btn:active {
      transform: scale(0.95);
    }
    
    /* Photo preview thumbnails */
    .photo-thumbnail {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .photo-thumbnail:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
    }
    
    /* Popup overlay */
    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 200;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .popup-image {
      max-width: 90%;
      max-height: 70%;
      object-fit: contain;
      border-radius: 12px;
    }
    
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .nav-btn:hover {
      background: rgba(255,255,255,0.4);
    }
    
    .nav-btn.prev {
      left: 20px;
    }
    
    .nav-btn.next {
      right: 20px;
    }
    

  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full soft-navy-bg">
  <div id="app" class="h-full w-full overflow-auto"><!-- LOGIN PAGE -->
   <div id="loginPage" class="page active flex-col items-center justify-center min-h-full w-full soft-navy-bg p-4">
    <div class="bg-white rounded-3xl p-8 md:p-12 w-full max-w-md fade-in shadow-2xl">
     <div class="flex justify-center mb-6"><img id="loginLogo" src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w200" alt="Logo Archipelago" class="w-32 h-32 object-contain" onerror="this.style.display='none'">
     </div>
     <h1 id="companyNameLogin" class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">ARCHIPELAGO DAILY WORKER</h1>
     <form id="loginForm" class="space-y-5">
      <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="username" placeholder="Masukkan username" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none transition-all text-gray-800 bg-white">
      </div>
      <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="password" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none transition-all text-gray-800 bg-white">
      </div>
      <div id="loginError" class="text-red-500 text-sm hidden">
       Username atau password salah!
      </div><button type="submit" class="w-full py-3 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition-all shadow-lg"> Login </button>
     </form>
    </div>
   </div><!-- MAIN ABSENSI PAGE -->
   <div id="absensiPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 id="appTitleHeader" class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
      <div class="flex items-center gap-2">
       <div class="text-right">
        <div id="currentDate" class="text-sm font-medium text-gray-300"></div>
        <div class="flex items-center gap-2"><span id="currentTime" class="text-2xl font-bold clock-time"></span> <span id="timezone" class="text-2xl font-bold clock-time"></span>
        </div>
       </div>
      </div>
     </div>
    </header>
    <main class="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full">
     <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex gap-3"><button onclick="setAllPresent()" class="px-5 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold shadow-lg flex items-center gap-2">
        <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
         <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
        </svg> Hadir Semua </button> <button onclick="resetAllStatus()" class="px-5 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all font-semibold shadow-lg flex items-center gap-2">
        <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
         <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
        </svg> Reset </button>
      </div><button onclick="showPage('recapMenuPage')" class="px-5 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all font-semibold shadow-lg flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
       </svg> Recap Absen </button> <button onclick="openSetupGuide()" class="px-5 py-3 bg-amber-500 text-white rounded-xl hover:bg-amber-600 transition-all font-semibold shadow-lg flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
       </svg> Setup Sheets </button>
     </div>
     <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
      <div class="relative w-full md:w-1/2"><input type="text" id="searchInput" placeholder="Cari nama pekerja..." class="w-full px-5 py-3 rounded-xl border-2 border-gray-300 focus:border-indigo-500 focus:outline-none transition-all text-gray-800 pl-12 bg-white">
       <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
       </svg>
      </div>
      <div class="bg-white rounded-xl px-5 py-3 shadow-lg flex items-center gap-6">
       <div class="flex items-center gap-2"><span class="text-green-500 font-bold text-lg" id="selectedCount">0</span> <span class="text-gray-600 text-sm">Dipilih</span>
       </div>
       <div class="w-px h-6 bg-gray-300"></div>
       <div class="flex items-center gap-2"><span class="text-red-500 font-bold text-lg" id="unselectedCount">0</span> <span class="text-gray-600 text-sm">Belum Dipilih</span>
       </div>
      </div>
     </div><!-- Loading State -->
     <div id="loadingWorkers" class="flex flex-col items-center justify-center py-12">
      <div class="loading-spinner mb-4"></div>
      <p class="text-white font-medium">Memuat data pekerja...</p>
     </div><!-- Search Results -->
     <div id="searchResults" class="hidden mb-6">
      <div class="w-full">
       <div id="searchResultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
       </div>
      </div>
     </div><!-- Worker Grid -->
     <div id="workerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6 hidden">
     </div><!-- Photo Upload -->
     <div class="bg-white rounded-2xl p-6 shadow-lg mb-4 w-full">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
       <svg class="w-6 h-6" fill="#1e3a5f" viewbox="0 0 24 24">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
       </svg> Upload Foto Absen</h3><button id="openCameraBtn" onclick="openCamera()" class="px-6 py-3 bg-blue-500 text-white rounded-xl cursor-pointer hover:bg-blue-600 transition-all font-medium inline-flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M12 15.2c1.77 0 3.2-1.43 3.2-3.2s-1.43-3.2-3.2-3.2-3.2 1.43-3.2 3.2 1.43 3.2 3.2 3.2zM9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
       </svg> Buka Kamera </button> <!-- Photo Thumbnails -->
      <div id="photoThumbnails" class="mt-4 flex flex-wrap gap-3 hidden">
      </div>
      <p id="photoCount" class="mt-3 text-sm text-gray-500 hidden">0 foto dipilih</p>
     </div><!-- Submit Button -->
     <div class="mb-8 w-full"><button id="submitBtn" onclick="submitAbsensi()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-lg shadow-xl hover:bg-green-600 hover:shadow-2xl transition-all flex items-center justify-center gap-2">
       <svg class="w-6 h-6 transform -rotate-45" fill="white" viewbox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
       </svg> Kirim Absensi </button>
     </div>
    </main>
   </div><!-- RECAP MENU PAGE -->
   <div id="recapMenuPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
      <div class="flex items-center gap-2">
       <div class="text-right">
        <div id="currentDateRecap" class="text-sm font-medium text-gray-300"></div>
        <div class="flex items-center gap-2"><span id="currentTimeRecap" class="text-2xl font-bold clock-time"></span> <span id="timezoneRecap" class="text-2xl font-bold clock-time"></span>
        </div>
       </div>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg> Back to Home </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-6 flex items-center justify-center gap-2">
      <svg class="w-8 h-8" fill="white" viewbox="0 0 24 24">
       <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
      </svg> Menu Recap</h2>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><button onclick="showTodayRecap()" class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all text-left group">
       <div class="mb-4">
        <svg class="w-12 h-12" fill="#1e3a5f" viewbox="0 0 24 24">
         <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
        </svg>
       </div><h3 class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition-all">Recap Hari Ini</h3><p class="text-gray-500 mt-2">Lihat absensi hari ini</p></button> <button onclick="showPage('calendarPage')" class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all text-left group">
       <div class="mb-4">
        <svg class="w-12 h-12" fill="#1e3a5f" viewbox="0 0 24 24">
         <path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z" />
        </svg>
       </div><h3 class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition-all">Recap Tanggal</h3><p class="text-gray-500 mt-2">Pilih tanggal di kalender</p></button> <button onclick="showPhotoRecap()" class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all text-left group">
       <div class="mb-4">
        <svg class="w-12 h-12" fill="#1e3a5f" viewbox="0 0 24 24">
         <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
        </svg>
       </div><h3 class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition-all">Foto Absen</h3><p class="text-gray-500 mt-2">Galeri foto absensi</p></button>
     </div>
    </main>
   </div><!-- TODAY RECAP PAGE -->
   <div id="todayRecapPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('recapMenuPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-2">Recap Hari Ini</h2>
     <div id="todayRecapDate" class="text-center text-lg font-semibold text-gray-300 mb-6"></div>
     <div id="todayRecapContent" class="bg-white rounded-2xl shadow-lg overflow-hidden">
     </div>
    </main>
   </div><!-- CALENDAR PAGE -->
   <div id="calendarPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('recapMenuPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button>
    </div>
    <main class="flex-1 p-6 max-w-lg mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-6">Pilih Tanggal</h2>
     <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6"><button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg></button>
       <h2 id="calendarMonth" class="text-xl font-bold text-gray-800"></h2><button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button>
      </div>
      <div class="grid grid-cols-7 gap-1 mb-2">
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Min
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Sen
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Sel
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Rab
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Kam
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Jum
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Sab
       </div>
      </div>
      <div id="calendarDays" class="grid grid-cols-7 gap-1">
      </div>
     </div>
    </main>
   </div><!-- DATE RECAP PAGE -->
   <div id="dateRecapPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('calendarPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 id="dateRecapTitle" class="text-2xl font-bold text-white text-center mb-6">Recap Tanggal</h2>
     <div id="dateRecapContent" class="bg-white rounded-2xl shadow-lg overflow-hidden">
     </div>
    </main>
   </div><!-- PHOTO FOLDERS PAGE -->
   <div id="photoFoldersPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('recapMenuPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-6">Foto Absen</h2>
     <div id="photoFoldersLoading" class="flex flex-col items-center justify-center py-12">
      <div class="loading-spinner mb-4"></div>
      <p class="text-white font-medium">Memuat folder foto...</p>
     </div>
     <div id="photoFolders" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 hidden">
     </div>
     <div id="noPhotosMessage" class="hidden text-center py-12 text-gray-300">
      <svg class="w-16 h-16 mx-auto mb-4" fill="white" viewbox="0 0 24 24">
       <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
      </svg>
      <p>Belum ada foto absen</p>
     </div>
    </main>
   </div><!-- PHOTO GALLERY PAGE -->
   <div id="photoGalleryPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('photoFoldersPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 id="galleryTitle" class="text-2xl font-bold text-white text-center mb-6">Galeri Foto</h2>
     <div id="photoGalleryLoading" class="flex flex-col items-center justify-center py-12 hidden">
      <div class="loading-spinner mb-4"></div>
      <p class="text-white font-medium">Memuat foto...</p>
     </div>
     <div id="photoGallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
     </div>
    </main>
   </div><!-- CAMERA VIEW -->
   <div id="cameraView" class="camera-container hidden">
    <video id="cameraVideo" class="camera-video" autoplay playsinline></video>
    <div id="locationStatus" class="absolute top-4 left-4 bg-black bg-opacity-50 text-white px-4 py-2 rounded-lg text-sm"><span id="locationText">üìç Mendapatkan lokasi...</span>
    </div><button onclick="closeCamera()" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white w-10 h-10 rounded-full flex items-center justify-center">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
     </svg></button>
    <div class="camera-controls"><button onclick="switchCamera()" class="bg-black bg-opacity-50 text-white w-12 h-12 rounded-full flex items-center justify-center">
      <svg class="w-6 h-6" fill="white" viewbox="0 0 24 24">
       <path d="M9 12c0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3-3 1.34-3 3zm13-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v4h2V6h3.83l1.83-2h4.68l1.83 2H20v4h2zm-4 8c0 1.1-.9 2-2 2H8c-1.1 0-2-.9-2-2v-1H4v1c0 2.21 1.79 4 4 4h8c2.21 0 4-1.79 4-4v-1h-2v1z" /><path d="M7.5 14l-2-2-2 2 2 2zm11-4l2-2 2 2-2 2z" />
      </svg></button> <button onclick="capturePhoto()" class="capture-btn"></button>
     <div class="w-12"></div>
    </div>
   </div><!-- PHOTO PREVIEW POPUP (After Capture) -->
   <div id="capturePreview" class="popup-overlay hidden"><img id="capturedImage" src="" alt="Captured" class="popup-image">
    <div class="flex gap-4 mt-6"><button onclick="retakePhoto()" class="px-8 py-3 bg-red-500 text-white rounded-xl font-semibold hover:bg-red-600 transition-all flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
      </svg> Foto Ulang </button> <button onclick="selectPhoto()" class="px-8 py-3 bg-green-500 text-white rounded-xl font-semibold hover:bg-green-600 transition-all flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
      </svg> Pilih Foto </button>
    </div>
   </div><!-- PHOTO VIEWER POPUP (View uploaded photos) -->
   <div id="photoViewer" class="popup-overlay hidden"><button onclick="closePhotoViewer()" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white w-10 h-10 rounded-full flex items-center justify-center z-10">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
     </svg></button> <button onclick="prevPhoto()" class="nav-btn prev">
     <svg class="w-6 h-6" fill="white" viewbox="0 0 24 24">
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
     </svg></button> <img id="viewerImage" src="" alt="Photo" class="popup-image"> <button onclick="nextPhoto()" class="nav-btn next">
     <svg class="w-6 h-6" fill="white" viewbox="0 0 24 24">
      <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
     </svg></button>
    <div id="photoViewerCounter" class="text-white mt-4 text-sm">
     1 / 1
    </div>
   </div><!-- Setup Guide Modal -->
   <div id="setupGuideModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90%] overflow-auto">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-bold text-gray-800">Setup Google Integration</h2><button onclick="closeSetupGuide()" class="p-2 hover:bg-gray-100 rounded-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg></button>
      </div>
      <div class="space-y-4 text-sm text-gray-700">
       <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <p class="font-semibold text-blue-800">üìã Google Apps Script untuk Upload Foto &amp; Absensi</p>
        <p class="text-blue-700 text-xs mt-1">Copy kode di bawah ini ke Apps Script Anda</p>
       </div>
       <div class="bg-gray-900 text-green-400 p-3 rounded font-mono text-xs overflow-x-auto max-h-64">
        <pre id="appsScriptCode">// Google Apps Script for Absen Archipelago
// Handles: Photo upload to Drive, Attendance to Sheets

const DRIVE_FOLDER_ID = '1CJ46h8M89mzc3XKEg-4hJPV-2voMN3OD';
const SPREADSHEET_ID = '1FllBcwBjTr_jfPylhyWwHt6ZE16j6fJpSa0C9hYEw44';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    
    if (data.action === 'uploadPhoto') {
      return uploadPhoto(data);
    } else if (data.action === 'submitAttendance') {
      return submitAttendance(data);
    }
    
    return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function doGet(e) {
  try {
    const action = e.parameter.action;
    
    if (action === 'getFolders') {
      return getFolders();
    } else if (action === 'getPhotos') {
      return getPhotos(e.parameter.folderId);
    }
    
    return jsonResponse({ status: 'OK', message: 'Absen API is running' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function uploadPhoto(data) {
  const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const folderName = data.folderName; // e.g., "31 January 2025"
  const fileName = data.fileName; // e.g., "Absen, 23:34.jpg"
  const base64Data = data.photoData.split(',')[1];
  const blob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'image/jpeg', fileName);
  
  // Find or create date folder
  let dateFolder;
  const folders = parentFolder.getFoldersByName(folderName);
  if (folders.hasNext()) {
    dateFolder = folders.next();
  } else {
    dateFolder = parentFolder.createFolder(folderName);
  }
  
  // Upload file
  const file = dateFolder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  return jsonResponse({
    success: true,
    fileId: file.getId(),
    fileUrl: file.getUrl(),
    thumbnailUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&amp;sz=w200',
    fullUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&amp;sz=w1920'
  });
}

function submitAttendance(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName('Absen recap');
  
  if (!sheet) {
    sheet = ss.insertSheet('Absen recap');
  }
  
  // Setup headers if needed
  sheet.getRange('A1').setValue('Tanggal');
  sheet.getRange('A2').setValue('Jam');
  
  // Add workers in column A
  if (data.workers &amp;&amp; data.workers.length &gt; 0) {
    for (let i = 0; i &lt; data.workers.length; i++) {
      sheet.getRange(i + 3, 1).setValue(data.workers[i]);
    }
  }
  
  // Find next column
  const lastCol = sheet.getLastColumn();
  const newCol = Math.max(lastCol + 1, 2);
  
  // Add date and time
  sheet.getRange(1, newCol).setValue(data.tanggal);
  sheet.getRange(2, newCol).setValue(data.jam);
  
  // Add attendance with colors
  const colors = {
    'Start Work': '#22c55e',
    'Finish Work': '#3b82f6',
    'Sakit': '#f97316',
    'Standby': '#a855f7',
    'Belum Absen': '#ef4444'
  };
  
  for (let j = 0; j &lt; data.attendance.length; j++) {
    const item = data.attendance[j];
    const cell = sheet.getRange(item.row, newCol);
    cell.setValue(item.status);
    cell.setBackground(colors[item.status] || '#ef4444');
    cell.setFontColor('#ffffff');
    cell.setHorizontalAlignment('center');
  }
  
  return jsonResponse({ success: true, column: newCol });
}

function getFolders() {
  const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const folders = parentFolder.getFolders();
  const result = [];
  
  while (folders.hasNext()) {
    const folder = folders.next();
    result.push({
      id: folder.getId(),
      name: folder.getName(),
      created: folder.getDateCreated().toISOString()
    });
  }
  
  // Sort by name (date) descending
  result.sort((a, b) =&gt; b.name.localeCompare(a.name));
  
  return jsonResponse({ success: true, folders: result });
}

function getPhotos(folderId) {
  const folder = DriveApp.getFolderById(folderId);
  const files = folder.getFiles();
  const result = [];
  
  while (files.hasNext()) {
    const file = files.next();
    if (file.getMimeType().startsWith('image/')) {
      result.push({
        id: file.getId(),
        name: file.getName(),
        thumbnailUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&amp;sz=w200',
        fullUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&amp;sz=w1920',
        created: file.getDateCreated().toISOString()
      });
    }
  }
  
  // Sort by name
  result.sort((a, b) =&gt; a.name.localeCompare(b.name));
  
  return jsonResponse({ success: true, photos: result });
}

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}</pre>
       </div><button onclick="copyAppsScript()" class="mt-2 px-4 py-2 bg-indigo-500 text-white rounded text-sm hover:bg-indigo-600"> Copy Kode </button>
       <div class="mt-4"><label class="block text-sm font-medium text-gray-700 mb-2">URL Web App:</label> <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/..." class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:outline-none"> <button onclick="saveScriptUrl()" class="mt-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600"> Simpan URL </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Toast Notification -->
   <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl hidden z-50"><span id="toastMessage">Berhasil!</span>
   </div><!-- Loading Overlay -->
   <div id="loadingOverlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-2xl p-8 text-center">
     <div class="animate-spin w-12 h-12 border-4 border-indigo-500 border-t-transparent rounded-full mx-auto mb-4"></div>
     <p id="loadingText" class="text-gray-700 font-medium">Memproses...</p>
    </div>
   </div>
  </div>
  <script>
    // ==================== CONFIG & STATE ====================
    const defaultConfig = {
      app_title: 'ABSEN ONLINE DAILY WORKER I.B.L.',
      company_name: 'ARCHIPELAGO DAILY WORKER'
    };

    let config = { ...defaultConfig };
    let allAbsensiData = [];
    let calendarDate = new Date();

    // Workers data
    let workers = [];
    let workerStatus = {};
    
    // Photos state
    let capturedPhotos = []; // Array of {thumbnail, fullData, location, timestamp}
    let currentViewerIndex = 0;
    let currentViewerPhotos = [];
    
    // Camera state
    let videoStream = null;
    let currentFacingMode = 'environment';
    let currentLocation = null;
    let locationRetryCount = 0;
    const MAX_LOCATION_RETRIES = 3;
    const LOCATION_TIMEOUT = 3000;
    

    
    // Google config
    const SHEET_ID = '1FllBcwBjTr_jfPylhyWwHt6ZE16j6fJpSa0C9hYEw44';
    const SHEET_NAME = 'Form responses 1';
    const SHEETS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
    const LOGO_URL = 'https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&sz=w100';
    
    let GOOGLE_SCRIPT_URL = localStorage.getItem('googleScriptUrl') || 'https://script.google.com/macros/s/AKfycbzTjKB4lTiZKafD34Ts-NWEC-qq6RTAYudu_r4X8eijJSDCUzz1RvRY1a4S2XTENBHxjQ/exec';



    // ==================== LOCATION ====================
    async function getLocationWithRetry() {
      locationRetryCount = 0;
      currentLocation = null;
      
      while (locationRetryCount < MAX_LOCATION_RETRIES) {
        try {
          const position = await new Promise((resolve, reject) => {
            navigator.geolocation.getCurrentPosition(resolve, reject, {
              timeout: LOCATION_TIMEOUT,
              enableHighAccuracy: true,
              maximumAge: 0
            });
          });
          
          // Reverse geocode
          const address = await reverseGeocode(position.coords.latitude, position.coords.longitude);
          currentLocation = address;
          document.getElementById('locationText').textContent = 'üìç ' + address;
          return address;
          
        } catch (error) {
          locationRetryCount++;
          document.getElementById('locationText').textContent = `üìç Mencoba lagi (${locationRetryCount}/${MAX_LOCATION_RETRIES})...`;
        }
      }
      
      currentLocation = 'Location unavailable';
      document.getElementById('locationText').textContent = 'üìç Location unavailable';
      return 'Location unavailable';
    }

    async function reverseGeocode(lat, lon) {
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=18&addressdetails=1`);
        const data = await response.json();
        
        if (data.display_name) {
          // Shorten the address
          const parts = data.display_name.split(', ');
          if (parts.length > 4) {
            return parts.slice(0, 4).join(', ');
          }
          return data.display_name;
        }
        return 'Location unavailable';
      } catch (error) {
        return 'Location unavailable';
      }
    }

    // ==================== CAMERA ====================
    async function openCamera() {
      try {
        document.getElementById('cameraView').classList.remove('hidden');
        document.getElementById('locationText').textContent = 'üìç Mendapatkan lokasi...';
        
        // Start getting location in background
        getLocationWithRetry();
        
        // Start camera
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: false
        });
        
        document.getElementById('cameraVideo').srcObject = videoStream;
        
      } catch (error) {
        showToast('Gagal membuka kamera', 'error');
        closeCamera();
      }
    }

    function closeCamera() {
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
        videoStream = null;
      }
      document.getElementById('cameraView').classList.add('hidden');
    }

    async function switchCamera() {
      currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
      
      if (videoStream) {
        videoStream.getTracks().forEach(track => track.stop());
      }
      
      try {
        videoStream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: currentFacingMode, width: { ideal: 1920 }, height: { ideal: 1080 } },
          audio: false
        });
        document.getElementById('cameraVideo').srcObject = videoStream;
      } catch (error) {
        showToast('Gagal mengganti kamera', 'error');
      }
    }

    async function capturePhoto() {
      const video = document.getElementById('cameraVideo');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      
      // Draw video frame
      ctx.drawImage(video, 0, 0);
      
      // Add watermark
      await addWatermark(ctx, canvas.width, canvas.height);
      
      // Get full quality image
      const fullData = canvas.toDataURL('image/jpeg', 0.95);
      
      // Show preview
      document.getElementById('capturedImage').src = fullData;
      document.getElementById('capturePreview').classList.remove('hidden');
      
      // Store temporarily
      window.tempCapturedPhoto = {
        fullData: fullData,
        location: currentLocation || 'Location unavailable',
        timestamp: new Date()
      };
    }

    async function addWatermark(ctx, width, height) {
      const now = new Date();
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      const dayName = days[now.getDay()];
      const day = now.getDate();
      const month = months[now.getMonth()];
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      const dateStr = `${dayName}, ${day} ${month} ${year}`;
      const timeStr = `${hours}:${minutes}`;
      const locationStr = currentLocation || 'Location unavailable';
      
      // Scale for different resolutions
      const scale = Math.min(width, height) / 1080;
      const padding = 20 * scale;
      const logoSize = 50 * scale;
      const fontSize = 16 * scale;
      const lineHeight = 24 * scale;
      
      // LEFT BOTTOM - Info card
      const cardX = padding;
      const cardHeight = logoSize + lineHeight * 3 + padding * 2;
      const cardY = height - cardHeight - padding;
      const cardWidth = Math.min(400 * scale, width * 0.6);
      
      // Draw card background
      ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
      ctx.beginPath();
      ctx.roundRect(cardX, cardY, cardWidth, cardHeight, 10 * scale);
      ctx.fill();
      
      // Draw logo placeholder (black version)
      ctx.fillStyle = '#000000';
      ctx.fillRect(cardX + padding, cardY + padding, logoSize, logoSize);
      
      // Try to load and draw logo
      try {
        const logoImg = new Image();
        logoImg.crossOrigin = 'anonymous';
        await new Promise((resolve) => {
          logoImg.onload = resolve;
          logoImg.onerror = resolve;
          logoImg.src = LOGO_URL;
          setTimeout(resolve, 1000);
        });
        
        if (logoImg.complete && logoImg.naturalWidth > 0) {
          ctx.drawImage(logoImg, cardX + padding, cardY + padding, logoSize, logoSize);
          // Apply black filter
          ctx.globalCompositeOperation = 'source-atop';
          ctx.fillStyle = '#000000';
          ctx.fillRect(cardX + padding, cardY + padding, logoSize, logoSize);
          ctx.globalCompositeOperation = 'source-over';
        }
      } catch (e) {}
      
      // Text info
      ctx.fillStyle = '#333333';
      ctx.font = `${fontSize}px Poppins, sans-serif`;
      
      const textX = cardX + padding + logoSize + padding;
      let textY = cardY + padding + fontSize;
      
      ctx.fillText(dateStr, textX, textY);
      textY += lineHeight;
      
      ctx.font = `bold ${fontSize * 1.2}px Poppins, sans-serif`;
      ctx.fillText(timeStr, textX, textY);
      textY += lineHeight;
      
      ctx.font = `${fontSize * 0.9}px Poppins, sans-serif`;
      ctx.fillStyle = '#666666';
      const maxTextWidth = cardWidth - logoSize - padding * 3;
      const truncatedLocation = truncateText(ctx, locationStr, maxTextWidth);
      ctx.fillText(truncatedLocation, textX, textY);
      
      // RIGHT TOP - Timemark badge
      const badgeText1 = 'Time';
      const badgeText2 = 'mark';
      const verifiedText = '100% photo verified';
      
      ctx.font = `bold ${fontSize * 1.5}px Poppins, sans-serif`;
      const badge1Width = ctx.measureText(badgeText1).width;
      const badge2Width = ctx.measureText(badgeText2).width;
      
      ctx.font = `${fontSize}px Poppins, sans-serif`;
      const verifiedWidth = ctx.measureText(verifiedText).width;
      
      const badgeX = width - Math.max(badge1Width + badge2Width, verifiedWidth) - padding * 2;
      const badgeY = padding + fontSize * 1.5;
      
      // Draw "Time" in orange
      ctx.font = `bold ${fontSize * 1.5}px Poppins, sans-serif`;
      ctx.fillStyle = '#f59e0b';
      ctx.fillText(badgeText1, badgeX, badgeY);
      
      // Draw "mark" in white
      ctx.fillStyle = '#ffffff';
      ctx.fillText(badgeText2, badgeX + badge1Width, badgeY);
      
      // Draw verified text
      ctx.font = `${fontSize}px Poppins, sans-serif`;
      ctx.fillText(verifiedText, badgeX, badgeY + lineHeight);
      
      // Add shadow to text for visibility
      ctx.shadowColor = 'rgba(0, 0, 0, 0.5)';
      ctx.shadowBlur = 4 * scale;
      ctx.shadowOffsetX = 2 * scale;
      ctx.shadowOffsetY = 2 * scale;
    }

    function truncateText(ctx, text, maxWidth) {
      if (ctx.measureText(text).width <= maxWidth) return text;
      
      let truncated = text;
      while (ctx.measureText(truncated + '...').width > maxWidth && truncated.length > 0) {
        truncated = truncated.slice(0, -1);
      }
      return truncated + '...';
    }

    function retakePhoto() {
      document.getElementById('capturePreview').classList.add('hidden');
      window.tempCapturedPhoto = null;
    }

    function selectPhoto() {
      if (window.tempCapturedPhoto) {
        // Create thumbnail (smaller version)
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement('canvas');
          const maxSize = 200;
          const ratio = Math.min(maxSize / img.width, maxSize / img.height);
          canvas.width = img.width * ratio;
          canvas.height = img.height * ratio;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          
          capturedPhotos.push({
            thumbnail: canvas.toDataURL('image/jpeg', 0.5),
            fullData: window.tempCapturedPhoto.fullData,
            location: window.tempCapturedPhoto.location,
            timestamp: window.tempCapturedPhoto.timestamp
          });
          
          renderPhotoThumbnails();
          window.tempCapturedPhoto = null;
        };
        img.src = window.tempCapturedPhoto.fullData;
      }
      
      document.getElementById('capturePreview').classList.add('hidden');
      closeCamera();
    }

    function renderPhotoThumbnails() {
      const container = document.getElementById('photoThumbnails');
      const countEl = document.getElementById('photoCount');
      
      if (capturedPhotos.length === 0) {
        container.classList.add('hidden');
        countEl.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      countEl.classList.remove('hidden');
      countEl.textContent = `${capturedPhotos.length} foto dipilih`;
      
      container.innerHTML = capturedPhotos.map((photo, index) => `
        <div class="relative">
          <img src="${photo.thumbnail}" class="photo-thumbnail" onclick="openPhotoViewer(${index}, 'captured')">
          <button onclick="removePhoto(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs hover:bg-red-600">√ó</button>
        </div>
      `).join('');
    }

    function removePhoto(index) {
      capturedPhotos.splice(index, 1);
      renderPhotoThumbnails();
    }

    // ==================== PHOTO VIEWER ====================
    function openPhotoViewer(index, source) {
      if (source === 'captured') {
        currentViewerPhotos = capturedPhotos.map(p => p.fullData);
      } else {
        currentViewerPhotos = source;
      }
      
      currentViewerIndex = index;
      updatePhotoViewer();
      document.getElementById('photoViewer').classList.remove('hidden');
    }

    function updatePhotoViewer() {
      document.getElementById('viewerImage').src = currentViewerPhotos[currentViewerIndex];
      document.getElementById('photoViewerCounter').textContent = `${currentViewerIndex + 1} / ${currentViewerPhotos.length}`;
    }

    function prevPhoto() {
      if (currentViewerIndex > 0) {
        currentViewerIndex--;
        updatePhotoViewer();
      }
    }

    function nextPhoto() {
      if (currentViewerIndex < currentViewerPhotos.length - 1) {
        currentViewerIndex++;
        updatePhotoViewer();
      }
    }

    function closePhotoViewer() {
      document.getElementById('photoViewer').classList.add('hidden');
    }

    // ==================== DRIVE INTEGRATION ====================
    async function uploadPhotoToDrive(photoData, timestamp) {
      if (!GOOGLE_SCRIPT_URL) {
        console.log('Google Script URL not configured');
        return null;
      }
      
      const now = timestamp || new Date();
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const folderName = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const fileName = `Absen, ${hours}:${minutes}.jpg`;
      
      try {
        const response = await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'uploadPhoto',
            folderName: folderName,
            fileName: fileName,
            photoData: photoData
          })
        });
        
        return { success: true };
      } catch (error) {
        console.error('Upload error:', error);
        return null;
      }
    }

    async function fetchPhotoFolders() {
      if (!GOOGLE_SCRIPT_URL) {
        return [];
      }
      
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getFolders`);
        const data = await response.json();
        return data.success ? data.folders : [];
      } catch (error) {
        console.error('Fetch folders error:', error);
        return [];
      }
    }

    async function fetchPhotosFromFolder(folderId) {
      if (!GOOGLE_SCRIPT_URL) {
        return [];
      }
      
      try {
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getPhotos&folderId=${folderId}`);
        const data = await response.json();
        return data.success ? data.photos : [];
      } catch (error) {
        console.error('Fetch photos error:', error);
        return [];
      }
    }

    // ==================== PHOTO RECAP ====================
    async function showPhotoRecap() {
      showPage('photoFoldersPage');
      
      document.getElementById('photoFoldersLoading').classList.remove('hidden');
      document.getElementById('photoFolders').classList.add('hidden');
      document.getElementById('noPhotosMessage').classList.add('hidden');
      
      const folders = await fetchPhotoFolders();
      
      document.getElementById('photoFoldersLoading').classList.add('hidden');
      
      if (folders.length === 0) {
        document.getElementById('noPhotosMessage').classList.remove('hidden');
        return;
      }
      
      const container = document.getElementById('photoFolders');
      container.classList.remove('hidden');
      container.innerHTML = folders.map(folder => `
        <button onclick="openPhotoFolder('${folder.id}', '${folder.name}')" class="photo-folder bg-white rounded-2xl p-6 shadow-lg text-center">
          <svg class="w-12 h-12 mx-auto mb-3" fill="#1e3a5f" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
          <h3 class="font-semibold text-gray-800">${folder.name}</h3>
        </button>
      `).join('');
    }

    async function openPhotoFolder(folderId, folderName) {
      showPage('photoGalleryPage');
      document.getElementById('galleryTitle').textContent = `Foto: ${folderName}`;
      
      document.getElementById('photoGalleryLoading').classList.remove('hidden');
      document.getElementById('photoGallery').innerHTML = '';
      
      const photos = await fetchPhotosFromFolder(folderId);
      
      document.getElementById('photoGalleryLoading').classList.add('hidden');
      
      if (photos.length === 0) {
        document.getElementById('photoGallery').innerHTML = '<p class="col-span-full text-center text-gray-300 py-8">Tidak ada foto di folder ini</p>';
        return;
      }
      
      const container = document.getElementById('photoGallery');
      container.innerHTML = photos.map((photo, index) => `
        <div class="gallery-photo bg-white rounded-xl overflow-hidden shadow-lg cursor-pointer" onclick="viewGalleryPhoto(${index})">
          <img src="${photo.thumbnailUrl}" alt="${photo.name}" class="w-full h-32 object-cover">
          <div class="p-2">
            <p class="text-xs text-gray-600 truncate">${photo.name}</p>
          </div>
        </div>
      `).join('');
      
      // Store photos for viewer
      window.galleryPhotos = photos.map(p => p.fullUrl);
    }

    function viewGalleryPhoto(index) {
      if (window.galleryPhotos) {
        openPhotoViewer(index, window.galleryPhotos);
      }
    }

    // ==================== WORKERS ====================
    function convertDriveUrl(url) {
      if (!url) return '';
      let match = url.match(/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
      if (match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w200`;
      match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w200`;
      return url;
    }

    async function fetchWorkersFromSheet() {
      try {
        const response = await fetch(SHEETS_URL);
        const text = await response.text();
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
        if (!jsonMatch) throw new Error('Parse error');
        
        const data = JSON.parse(jsonMatch[1]);
        const rows = data.table.rows;
        
        workers = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (row.c && row.c[1] && row.c[1].v) {
            workers.push({
              id: i + 1,
              name: row.c[1].v,
              photo: row.c[2] && row.c[2].v ? convertDriveUrl(row.c[2].v) : ''
            });
          }
        }
        
        workers.forEach(w => workerStatus[w.id] = null);
        return true;
      } catch (error) {
        console.error('Error fetching workers:', error);
        return false;
      }
    }

    function getUserIcon(size = 40) {
      return `<svg width="${size}" height="${size}" fill="#1e3a5f" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
    }

    function getWorkerPhotoHtml(worker, size = 60) {
      if (worker.photo) {
        return `<img src="${worker.photo}" alt="${worker.name}" class="worker-photo-img" style="width:${size}px;height:${size}px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                <div style="display:none;width:${size}px;height:${size}px;border-radius:12px;" class="flex items-center justify-center bg-gray-200">${getUserIcon(size * 0.6)}</div>`;
      }
      return `<div class="flex items-center justify-center bg-gray-200" style="width:${size}px;height:${size}px;border-radius:12px;">${getUserIcon(size * 0.6)}</div>`;
    }

    function updateStatusCounter() {
      const selectedCount = Object.values(workerStatus).filter(s => s !== null).length;
      document.getElementById('selectedCount').textContent = selectedCount;
      document.getElementById('unselectedCount').textContent = workers.length - selectedCount;
    }

    function renderWorkerGrid(filteredWorkers = workers) {
      const grid = document.getElementById('workerGrid');
      document.getElementById('loadingWorkers').classList.add('hidden');
      grid.classList.remove('hidden');
      grid.innerHTML = '';
      updateStatusCounter();
      
      if (filteredWorkers.length === 0) {
        grid.innerHTML = `<div class="col-span-full text-center py-12 text-white"><p>Tidak ada data pekerja</p></div>`;
        return;
      }
      
      filteredWorkers.forEach(worker => {
        const status = workerStatus[worker.id];
        const isSelected = status !== null;
        
        const card = document.createElement('div');
        card.className = `worker-card bg-white rounded-2xl p-4 shadow-lg transition-all cursor-pointer ${isSelected ? 'selected' : ''}`;
        card.dataset.workerId = worker.id;
        
        const getStatusBtnClass = (btnStatus, color) => {
          const isActive = status === btnStatus;
          return `status-btn px-2 py-1 ${color} text-white rounded-lg text-xs ${isActive ? 'selected font-bold' : 'font-medium'} hover:opacity-80`;
        };
        
        card.innerHTML = `
          <div class="text-center mb-3">
            <div class="mb-2 flex justify-center">${getWorkerPhotoHtml(worker, 60)}</div>
            <h3 class="worker-name font-semibold text-gray-800 text-sm">${worker.name}</h3>
            <p class="status-text text-xs mt-1 ${status ? 'text-gray-600' : 'text-gray-400'}">${status || 'Belum dipilih'}</p>
          </div>
          <div class="grid grid-cols-2 gap-1">
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Start Work')" class="${getStatusBtnClass('Start Work', 'bg-green-500')} whitespace-nowrap text-[10px]">Start Work</button>
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Finish Work')" class="${getStatusBtnClass('Finish Work', 'bg-blue-500')} whitespace-nowrap text-[10px]">Finish Work</button>
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Sakit')" class="${getStatusBtnClass('Sakit', 'bg-orange-500')} text-[10px]">Sakit</button>
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Standby')" class="${getStatusBtnClass('Standby', 'bg-purple-500')} text-[10px]">Standby</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    function toggleStatus(workerId, status) {
      workerStatus[workerId] = workerStatus[workerId] === status ? null : status;
      renderWorkerGrid();
    }

    function setAllPresent() {
      workers.forEach(w => workerStatus[w.id] = 'Start Work');
      renderWorkerGrid();
      showToast('Semua pekerja ditandai hadir!');
    }

    function resetAllStatus() {
      workers.forEach(w => workerStatus[w.id] = null);
      renderWorkerGrid();
      showToast('Status absen direset!');
    }

    // ==================== SEARCH ====================
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase().trim();
      
      if (query === '') {
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workerGrid').classList.remove('hidden');
        return;
      }
      
      const filtered = workers.filter(w => w.name.toLowerCase().includes(query));
      
      if (filtered.length > 0) {
        document.getElementById('workerGrid').classList.add('hidden');
        document.getElementById('searchResults').classList.remove('hidden');
        renderSearchResults(filtered);
      } else {
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workerGrid').classList.remove('hidden');
      }
    });

    function renderSearchResults(filteredWorkers) {
      const container = document.getElementById('searchResultsGrid');
      container.innerHTML = '';
      
      filteredWorkers.forEach(worker => {
        const status = workerStatus[worker.id];
        const isSelected = status !== null;
        
        const getStatusBtnClass = (btnStatus, color) => {
          const isActive = status === btnStatus;
          return `status-btn px-2 py-1 ${color} text-white rounded-lg text-xs ${isActive ? 'selected font-bold' : 'font-medium'} hover:opacity-80`;
        };
        
        const card = document.createElement('div');
        card.className = `worker-card bg-white rounded-2xl p-4 shadow-lg transition-all cursor-pointer fade-in ${isSelected ? 'selected' : ''}`;
        
        card.innerHTML = `
          <div class="text-center mb-3">
            <div class="mb-2 flex justify-center">${getWorkerPhotoHtml(worker, 60)}</div>
            <h3 class="worker-name font-semibold text-gray-800 text-sm">${worker.name}</h3>
            <p class="status-text text-xs mt-1 ${status ? 'text-gray-600' : 'text-gray-400'}">${status || 'Belum dipilih'}</p>
          </div>
          <div class="grid grid-cols-2 gap-1">
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Start Work')" class="${getStatusBtnClass('Start Work', 'bg-green-500')} whitespace-nowrap text-[10px]">Start Work</button>
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Finish Work')" class="${getStatusBtnClass('Finish Work', 'bg-blue-500')} whitespace-nowrap text-[10px]">Finish Work</button>
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Sakit')" class="${getStatusBtnClass('Sakit', 'bg-orange-500')} text-[10px]">Sakit</button>
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Standby')" class="${getStatusBtnClass('Standby', 'bg-purple-500')} text-[10px]">Standby</button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function setStatus(workerId, status) {
      workerStatus[workerId] = workerStatus[workerId] === status ? null : status;
      
      setTimeout(() => {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workerGrid').classList.remove('hidden');
        renderWorkerGrid();
      }, 500);
    }

    // ==================== SUBMIT ====================
    async function submitAbsensi() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div> Mengirim...';
      
      showLoading(true, 'Mengupload foto...');
      
      const now = new Date();
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const monthsId = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      const tanggalFormatted = `${now.getDate()} ${monthsId[now.getMonth()]} ${now.getFullYear()}`;
      const jamFormatted = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      try {
        // Upload photos to Drive
        for (let i = 0; i < capturedPhotos.length; i++) {
          showLoading(true, `Mengupload foto ${i + 1}/${capturedPhotos.length}...`);
          await uploadPhotoToDrive(capturedPhotos[i].fullData, capturedPhotos[i].timestamp);
        }
        
        // Submit attendance to sheet
        showLoading(true, 'Mengirim absensi...');
        
        const attendanceData = workers.map((worker, index) => ({
          row: index + 3,
          status: workerStatus[worker.id] || 'Belum Absen'
        }));
        
        if (GOOGLE_SCRIPT_URL) {
          await fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'submitAttendance',
              tanggal: tanggalFormatted,
              jam: jamFormatted,
              workers: workers.map(w => w.name),
              attendance: attendanceData
            })
          });
        }
        
        // Save to Data SDK
        if (window.dataSdk) {
          const dateStr = now.toLocaleDateString('id-ID');
          const timeStr = now.toLocaleTimeString('id-ID');
          
          for (const worker of workers) {
            if (workerStatus[worker.id]) {
              await window.dataSdk.create({
                type: 'attendance',
                date: dateStr,
                time: timeStr,
                worker_name: worker.name,
                worker_photo: worker.photo || '',
                status: workerStatus[worker.id],
                photo_url: ''
              });
            }
          }
        }
        
        showToast('Absensi berhasil dikirim! ‚úÖ');
        resetAllStatus();
        capturedPhotos = [];
        renderPhotoThumbnails();
        
      } catch (error) {
        console.error('Submit error:', error);
        showToast('Gagal mengirim absensi!', 'error');
      } finally {
        showLoading(false);
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<svg class="w-6 h-6 transform -rotate-45" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg> Kirim Absensi';
      }
    }

    // ==================== RECAP ====================
    function showTodayRecap() {
      const today = new Date().toLocaleDateString('id-ID');
      document.getElementById('todayRecapDate').textContent = today;
      
      const todayData = allAbsensiData.filter(d => d.date === today && d.type === 'attendance');
      renderRecapTable(todayData, 'todayRecapContent');
      
      showPage('todayRecapPage');
    }

    function showDateRecap(dateStr) {
      document.getElementById('dateRecapTitle').textContent = `Recap: ${dateStr}`;
      
      const dateData = allAbsensiData.filter(d => d.date === dateStr && d.type === 'attendance');
      renderRecapTable(dateData, 'dateRecapContent');
      
      showPage('dateRecapPage');
    }

    function renderRecapTable(data, containerId) {
      const container = document.getElementById(containerId);
      
      if (data.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500"><p>Tidak ada data absensi</p></div>';
        return;
      }
      
      const statusBgColors = {
        'Start Work': '#22c55e',
        'Finish Work': '#3b82f6',
        'Sakit': '#f97316',
        'Standby': '#a855f7',
        'Belum Absen': '#ef4444'
      };
      
      const timeGroups = {};
      data.forEach(item => {
        if (!timeGroups[item.time]) timeGroups[item.time] = {};
        timeGroups[item.time][item.worker_name] = item.status;
      });
      
      const times = Object.keys(timeGroups).sort();
      
      let html = `<div class="overflow-x-auto"><table class="w-full border-collapse"><tbody>`;
      
      html += `<tr><td class="border border-gray-300 px-4 py-3 bg-gray-100 font-bold text-gray-700">Jam</td>`;
      times.forEach(time => {
        html += `<td class="border border-gray-300 px-4 py-3 bg-white text-center font-medium">${time}</td>`;
      });
      html += `</tr>`;
      
      workers.forEach(worker => {
        html += `<tr><td class="border border-gray-300 px-4 py-3 bg-gray-50"><div class="flex items-center gap-2">`;
        html += worker.photo ? `<img src="${worker.photo}" class="w-8 h-8 rounded-lg object-cover" onerror="this.style.display='none'">` : `<div class="w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg">${getUserIcon(20)}</div>`;
        html += `<span class="font-medium text-gray-800 text-sm">${worker.name}</span></div></td>`;
        
        times.forEach(time => {
          const status = timeGroups[time][worker.name] || 'Belum Absen';
          const bgColor = statusBgColors[status];
          html += `<td class="border border-gray-300 px-3 py-2 text-center" style="background-color: ${bgColor};"><span class="text-white font-medium text-sm">${status}</span></td>`;
        });
        
        html += `</tr>`;
      });
      
      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }

    // ==================== CALENDAR ====================
    function renderCalendar() {
      const year = calendarDate.getFullYear();
      const month = calendarDate.getMonth();
      const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const datesWithData = new Set(allAbsensiData.filter(d => d.type === 'attendance').map(d => d.date));
      
      const container = document.getElementById('calendarDays');
      container.innerHTML = '';
      
      for (let i = 0; i < firstDay; i++) {
        container.innerHTML += '<div class="p-2"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = new Date(year, month, day).toLocaleDateString('id-ID');
        const hasData = datesWithData.has(dateStr);
        
        const dayEl = document.createElement('button');
        dayEl.className = `calendar-day p-2 text-center rounded-lg transition-all ${hasData ? 'has-data' : 'hover:bg-gray-100'}`;
        dayEl.textContent = day;
        dayEl.onclick = () => showDateRecap(dateStr);
        
        container.appendChild(dayEl);
      }
    }

    function changeMonth(delta) {
      calendarDate.setMonth(calendarDate.getMonth() + delta);
      renderCalendar();
    }

    // ==================== NAVIGATION ====================
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      if (pageId === 'calendarPage') renderCalendar();
    }

    // ==================== CLOCK ====================
    function updateClock() {
      const now = new Date();
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      
      const dateStr = now.toLocaleDateString('id-ID', dateOptions);
      const timeStr = now.toLocaleTimeString('id-ID', timeOptions);
      
      const offset = now.getTimezoneOffset();
      const tz = offset === -420 ? 'WIB' : offset === -480 ? 'WITA' : offset === -540 ? 'WIT' : 'WIB';
      
      ['currentDate', 'currentDateRecap'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = dateStr;
      });
      
      ['currentTime', 'currentTimeRecap'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = timeStr;
      });
      
      ['timezone', 'timezoneRecap'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = tz;
      });
    }

    setInterval(updateClock, 1000);
    updateClock();

    // ==================== UTILITIES ====================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-xl z-50 toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white`;
      document.getElementById('toastMessage').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function showLoading(show, text = 'Memproses...') {
      const overlay = document.getElementById('loadingOverlay');
      document.getElementById('loadingText').textContent = text;
      if (show) overlay.classList.remove('hidden');
      else overlay.classList.add('hidden');
    }

    function openSetupGuide() {
      document.getElementById('setupGuideModal').classList.remove('hidden');
      document.getElementById('scriptUrlInput').value = GOOGLE_SCRIPT_URL;
    }

    function closeSetupGuide() {
      document.getElementById('setupGuideModal').classList.add('hidden');
    }

    function copyAppsScript() {
      const code = document.getElementById('appsScriptCode').textContent;
      navigator.clipboard.writeText(code).then(() => showToast('Kode berhasil dicopy!'));
    }

    function saveScriptUrl() {
      const url = document.getElementById('scriptUrlInput').value.trim();
      if (!url.startsWith('https://script.google.com/')) {
        showToast('URL tidak valid!', 'error');
        return;
      }
      localStorage.setItem('googleScriptUrl', url);
      GOOGLE_SCRIPT_URL = url;
      showToast('URL berhasil disimpan! ‚úÖ');
      closeSetupGuide();
    }

    // ==================== ELEMENT SDK ====================
    async function initElementSdk() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            document.getElementById('appTitleHeader').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('companyNameLogin').textContent = config.company_name || defaultConfig.company_name;
          },
          mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['company_name', cfg.company_name || defaultConfig.company_name]
          ])
        });
        config = { ...defaultConfig, ...window.elementSdk.config };
      }
    }

    // ==================== DATA SDK ====================
    const dataHandler = {
      onDataChanged(data) {
        allAbsensiData = data || [];
      }
    };

    async function initDataSdk() {
      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }
    }

    // ==================== LOGIN ====================
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (username === 'archipelago' && password === 'balivibes') {
        document.getElementById('loginError').classList.add('hidden');
        showPage('absensiPage');
      } else {
        document.getElementById('loginError').classList.remove('hidden');
      }
    });

    // ==================== INIT ====================
    async function init() {
      await initElementSdk();
      await initDataSdk();
      await fetchWorkersFromSheet();
      renderWorkerGrid();
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b6c493f6009e9d5',t:'MTc2NzIxMDQxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
