<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Absen Archipelago</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">
  <style>
    body {
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    * {
      box-sizing: border-box;
    }
    
    .page {
      display: none;
    }
    
    .page.active {
      display: flex;
    }
    
    .soft-navy-bg {
      background: #1e3a5f;
    }
    
    .darker-header {
      background: #0f2744;
    }
    
    .status-btn {
      transition: all 0.2s ease;
    }
    
    .status-btn:hover {
      transform: scale(1.05);
    }
    
    .status-btn.selected {
      font-weight: 700 !important;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transform: scale(1.05);
    }
    
    .worker-card.selected {
      background: #ff1493 !important;
      border: 3px solid #ff006a !important;
      box-shadow: 0 0 25px rgba(255, 20, 147, 0.7) !important;
    }
    
    .worker-card.selected .worker-name,
    .worker-card.selected .status-text {
      color: white !important;
      font-weight: 700 !important;
    }
    
    .clock-time {
      color: #f59e0b;
      font-weight: 700;
    }
    
    .calendar-day:hover {
      background: #3b82f6;
      color: white;
    }
    
    .calendar-day.has-data {
      background: #10b981;
      color: white;
    }
    
    .photo-folder {
      transition: all 0.3s ease;
    }
    
    .photo-folder:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .gallery-photo {
      transition: all 0.3s ease;
    }
    
    .gallery-photo:hover {
      transform: scale(1.05);
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
      animation: fadeIn 0.3s ease forwards;
    }
    
    .toast {
      animation: slideIn 0.3s ease, slideOut 0.3s ease 2.7s forwards;
    }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(100%); opacity: 0; }
    }

    input[type="file"] {
      display: none;
    }
    
    .logo-white {
      filter: brightness(0) invert(1);
    }
    
    .worker-photo-img {
      width: 60px;
      height: 60px;
      border-radius: 12px;
      object-fit: cover;
      border: 3px solid #e5e7eb;
    }
    
    .worker-card.selected .worker-photo-img {
      border-color: white;
    }
    
    .loading-spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #1e3a5f;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .photo-thumbnail {
      width: 80px;
      height: 80px;
      border-radius: 12px;
      object-fit: cover;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }
    
    .photo-thumbnail:hover {
      border-color: #3b82f6;
      transform: scale(1.05);
    }
    
    .popup-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      z-index: 200;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .popup-image {
      max-width: 90%;
      max-height: 70%;
      object-fit: contain;
      border-radius: 12px;
    }
    
    .nav-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(255,255,255,0.2);
      border: none;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .nav-btn:hover {
      background: rgba(255,255,255,0.4);
    }
    
    .nav-btn.prev {
      left: 20px;
    }
    
    .nav-btn.next {
      right: 20px;
    }
    
    .location-status {
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    
    .refresh-icon.spinning {
      animation: spin 1s linear infinite;
    }
    
    .btn-loading {
      opacity: 0.7;
      pointer-events: none;
    }
    
    .status-card-clickable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .status-card-clickable:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    
    .status-card-clickable:active {
      transform: scale(0.98);
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
 </head>
 <body class="h-full soft-navy-bg">
  <div id="app" class="h-full w-full overflow-auto"><!-- LOGIN PAGE -->
   <div id="loginPage" class="page active flex-col items-center justify-center min-h-full w-full soft-navy-bg p-4">
    <div class="bg-white rounded-3xl p-8 md:p-12 w-full max-w-md fade-in shadow-2xl">
     <div class="flex justify-center mb-6"><img id="loginLogo" src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w200" alt="Logo Archipelago" class="w-32 h-32 object-contain" onerror="this.style.display='none'">
     </div>
     <h1 id="companyNameLogin" class="text-2xl md:text-3xl font-bold text-center text-gray-800 mb-8">ARCHIPELAGO DAILY WORKER</h1>
     <form id="loginForm" class="space-y-5">
      <div><label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label> <input type="text" id="username" placeholder="Masukkan username" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none transition-all text-gray-800 bg-white">
      </div>
      <div><label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label> <input type="password" id="password" placeholder="Masukkan password" class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-blue-400 focus:outline-none transition-all text-gray-800 bg-white">
      </div>
      <div id="loginError" class="text-red-500 text-sm hidden">
       Username atau password salah!
      </div><button type="submit" class="w-full py-3 bg-green-500 text-white font-semibold rounded-xl hover:bg-green-600 transition-all shadow-lg"> Login </button>
     </form>
    </div>
   </div><!-- MAIN ABSENSI PAGE -->
   <div id="absensiPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 id="appTitleHeader" class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
      <div class="flex items-center gap-2">
       <div class="text-right">
        <div id="currentDate" class="text-sm font-medium text-gray-300"></div>
        <div class="flex items-center gap-2"><span id="currentTime" class="text-2xl font-bold clock-time"></span> <span id="timezone" class="text-2xl font-bold clock-time"></span>
        </div>
       </div>
      </div>
     </div>
    </header>
    <main class="flex-1 p-4 md:p-6 max-w-7xl mx-auto w-full">
     <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
      <div class="flex gap-3"><button onclick="setAllPresent()" class="px-5 py-3 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-semibold shadow-lg flex items-center gap-2">
        <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
         <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z" />
        </svg> Hadir Semua </button> <button onclick="resetAllStatus()" class="px-5 py-3 bg-red-500 text-white rounded-xl hover:bg-red-600 transition-all font-semibold shadow-lg flex items-center gap-2">
        <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
         <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
        </svg> Reset </button>
      </div><button onclick="showPage('recapMenuPage')" class="px-5 py-3 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all font-semibold shadow-lg flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
       </svg> Recap Absen </button> <button onclick="openSetupGuide()" class="px-5 py-3 bg-amber-500 text-white rounded-xl hover:bg-amber-600 transition-all font-semibold shadow-lg flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M19.14 12.94c.04-.31.06-.63.06-.94 0-.31-.02-.63-.06-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.04.31-.06.63-.06.94s.02.63.06.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z" />
       </svg> Setup Sheets </button>
     </div>
     <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
      <div class="relative w-full md:w-1/2"><input type="text" id="searchInput" placeholder="Cari nama pekerja..." class="w-full px-5 py-3 rounded-xl border-2 border-gray-300 focus:border-indigo-500 focus:outline-none transition-all text-gray-800 pl-12 bg-white">
       <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
       </svg>
      </div>
      <div class="bg-white rounded-xl px-5 py-3 shadow-lg flex items-center gap-6">
       <div class="flex items-center gap-2"><span class="text-green-500 font-bold text-lg" id="selectedCount">0</span> <span class="text-gray-600 text-sm">Dipilih</span>
       </div>
       <div class="w-px h-6 bg-gray-300"></div>
       <div class="flex items-center gap-2"><span class="text-red-500 font-bold text-lg" id="unselectedCount">0</span> <span class="text-gray-600 text-sm">Belum Dipilih</span>
       </div>
      </div>
     </div>
     <div id="loadingWorkers" class="flex flex-col items-center justify-center py-12">
      <div class="loading-spinner mb-4"></div>
      <p class="text-white font-medium">Memuat data pekerja...</p>
     </div>
     <div id="searchResults" class="hidden mb-6">
      <div class="w-full">
       <div id="searchResultsGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
       </div>
      </div>
     </div>
     <div id="workerGrid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-6 hidden">
     </div>
     <div class="bg-white rounded-2xl p-6 shadow-lg mb-4 w-full">
      <h3 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
       <svg class="w-6 h-6" fill="#1e3a5f" viewbox="0 0 24 24">
        <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" /><path d="M20 4h-3.17L15 2H9L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-8 13c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
       </svg> Upload Foto Absen</h3><label for="photoInput" class="px-6 py-3 bg-blue-500 text-white rounded-xl cursor-pointer hover:bg-blue-600 transition-all font-medium inline-flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M12 15.2c1.77 0 3.2-1.43 3.2-3.2s-1.43-3.2-3.2-3.2-3.2 1.43-3.2 3.2 1.43 3.2 3.2 3.2zM9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z" />
       </svg> Upload Foto </label> <input type="file" id="photoInput" accept="image/*" multiple onchange="handlePhotoUpload(event)">
      <div id="photoThumbnails" class="mt-4 flex flex-wrap gap-3 hidden">
      </div>
      <p id="photoCount" class="mt-3 text-sm text-gray-500 hidden">0 foto dipilih</p>
     </div>
     <div class="mb-8 w-full"><button id="submitBtn" onclick="submitAbsensi()" class="w-full py-4 bg-green-500 text-white rounded-xl font-bold text-lg shadow-xl hover:bg-green-600 hover:shadow-2xl transition-all flex items-center justify-center gap-2">
       <svg class="w-6 h-6 transform -rotate-45" fill="white" viewbox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
       </svg> Kirim Absensi </button>
     </div>
    </main>
   </div><!-- RECAP MENU PAGE -->
   <div id="recapMenuPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
      <div class="flex items-center gap-2">
       <div class="text-right">
        <div id="currentDateRecap" class="text-sm font-medium text-gray-300"></div>
        <div class="flex items-center gap-2"><span id="currentTimeRecap" class="text-2xl font-bold clock-time"></span> <span id="timezoneRecap" class="text-2xl font-bold clock-time"></span>
        </div>
       </div>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg> Back to Home </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-6 flex items-center justify-center gap-2">
      <svg class="w-8 h-8" fill="white" viewbox="0 0 24 24">
       <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
      </svg> Menu Recap</h2>
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6"><button onclick="showTodayRecap()" class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all text-left group">
       <div class="mb-4">
        <svg class="w-12 h-12" fill="#1e3a5f" viewbox="0 0 24 24">
         <path d="M19 4h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11zM9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2z" />
        </svg>
       </div><h3 class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition-all">Recap Hari Ini</h3><p class="text-gray-500 mt-2">Lihat absensi hari ini</p></button> <button onclick="showPage('calendarPage')" class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all text-left group">
       <div class="mb-4">
        <svg class="w-12 h-12" fill="#1e3a5f" viewbox="0 0 24 24">
         <path d="M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 18H4V8h16v13z" />
        </svg>
       </div><h3 class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition-all">Recap Tanggal</h3><p class="text-gray-500 mt-2">Pilih tanggal di kalender</p></button> <button onclick="showPhotoRecap()" class="bg-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all text-left group">
       <div class="mb-4">
        <svg class="w-12 h-12" fill="#1e3a5f" viewbox="0 0 24 24">
         <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
        </svg>
       </div><h3 class="text-xl font-bold text-gray-800 group-hover:text-indigo-600 transition-all">Foto Absen</h3><p class="text-gray-500 mt-2">Galeri foto absensi</p></button>
     </div>
    </main>
   </div><!-- TODAY RECAP PAGE -->
   <div id="todayRecapPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-between gap-3 p-4 max-w-7xl mx-auto w-full">
     <div class="flex gap-3"><button onclick="showWorkerHoursPage('today')" class="px-5 py-2 bg-amber-500 text-white rounded-xl hover:bg-amber-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
       </svg> Recap Jam Kerja </button> <button id="refreshBtnToday" onclick="refreshDataFromSheet('today')" class="px-5 py-2 bg-cyan-500 text-white rounded-xl hover:bg-cyan-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5 refresh-icon" fill="white" viewbox="0 0 24 24">
        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
       </svg> Refresh Data </button>
     </div>
     <div class="flex gap-3"><button onclick="showPage('recapMenuPage')" class="px-5 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
       </svg> Kembali </button> <button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
       </svg> Back to Home </button>
     </div>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-2">Recap Hari Ini</h2>
     <div id="todayRecapDate" class="text-center text-lg font-semibold text-gray-300 mb-4"></div>
     <div id="todayStatusCards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-6">
     </div>
     <div id="todayRecapContent" class="bg-white rounded-2xl shadow-lg overflow-hidden">
     </div>
    </main>
   </div><!-- CALENDAR PAGE -->
   <div id="calendarPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('recapMenuPage')" class="px-5 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button> <button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg> Back to Home </button>
    </div>
    <main class="flex-1 p-6 max-w-lg mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-6">Pilih Tanggal</h2>
     <div class="bg-white rounded-2xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6"><button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg></button>
       <h2 id="calendarMonth" class="text-xl font-bold text-gray-800"></h2><button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-lg transition-all">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg></button>
      </div>
      <div class="grid grid-cols-7 gap-1 mb-2">
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Min
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Sen
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Sel
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Rab
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Kam
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Jum
       </div>
       <div class="text-center text-sm font-medium text-gray-500 py-2">
        Sab
       </div>
      </div>
      <div id="calendarDays" class="grid grid-cols-7 gap-1">
      </div>
     </div>
    </main>
   </div><!-- DATE RECAP PAGE -->
   <div id="dateRecapPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-between gap-3 p-4 max-w-7xl mx-auto w-full">
     <div class="flex gap-3"><button onclick="showWorkerHoursPage('date')" class="px-5 py-2 bg-amber-500 text-white rounded-xl hover:bg-amber-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z" />
       </svg> Recap Jam Kerja </button> <button id="refreshBtnDate" onclick="refreshDataFromSheet('date')" class="px-5 py-2 bg-cyan-500 text-white rounded-xl hover:bg-cyan-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5 refresh-icon" fill="white" viewbox="0 0 24 24">
        <path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z" />
       </svg> Refresh Data </button>
     </div>
     <div class="flex gap-3"><button onclick="showPage('calendarPage')" class="px-5 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
       </svg> Kembali </button> <button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
       <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
       </svg> Back to Home </button>
     </div>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 id="dateRecapTitle" class="text-2xl font-bold text-white text-center mb-4">Recap Tanggal</h2>
     <div id="dateStatusCards" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 mb-6">
     </div>
     <div id="dateRecapContent" class="bg-white rounded-2xl shadow-lg overflow-hidden">
     </div>
    </main>
   </div><!-- PHOTO FOLDERS PAGE -->
   <div id="photoFoldersPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('recapMenuPage')" class="px-5 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button> <button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg> Back to Home </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-6">Foto Absen</h2>
     <div id="photoFoldersLoading" class="flex flex-col items-center justify-center py-12">
      <div class="loading-spinner mb-4"></div>
      <p class="text-white font-medium">Memuat folder foto...</p>
      <p class="text-gray-400 text-sm mt-2">Mohon tunggu sebentar</p>
     </div>
     <div id="photoFolders" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 hidden">
     </div>
     <div id="noPhotosMessage" class="hidden text-center py-12 text-gray-300">
      <svg class="w-16 h-16 mx-auto mb-4" fill="white" viewbox="0 0 24 24">
       <path d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
      </svg>
      <p>Belum ada foto absen</p>
     </div>
    </main>
   </div><!-- PHOTO GALLERY PAGE -->
   <div id="photoGalleryPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button onclick="showPage('photoFoldersPage')" class="px-5 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button> <button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg> Back to Home </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 id="galleryTitle" class="text-2xl font-bold text-white text-center mb-6">Galeri Foto</h2>
     <div id="photoGalleryLoading" class="flex flex-col items-center justify-center py-12">
      <div class="loading-spinner mb-4"></div>
      <p class="text-white font-medium">Memuat foto...</p>
      <p class="text-gray-400 text-sm mt-2">Mohon tunggu sebentar</p>
     </div>
     <div id="photoGallery" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
     </div>
    </main>
   </div><!-- WORKER HOURS PAGE -->
   <div id="workerHoursPage" class="page flex-col min-h-full w-full soft-navy-bg">
    <header class="darker-header shadow-md px-4 py-4 sticky top-0 z-50">
     <div class="max-w-7xl mx-auto flex flex-col md:flex-row items-center justify-between gap-4">
      <div class="flex items-center gap-4"><img src="https://drive.google.com/thumbnail?id=10un5eCNXYwHkgznim3T4lRMwICFWQ8Bw&amp;sz=w100" alt="Logo" class="w-12 h-12 object-contain logo-white" onerror="this.style.display='none'">
       <h1 class="text-lg md:text-xl font-bold text-white uppercase tracking-wide">ABSEN ONLINE DAILY WORKER I.B.L.</h1>
      </div>
     </div>
    </header>
    <div class="flex justify-end gap-3 p-4 max-w-7xl mx-auto w-full"><button id="workerHoursBackBtn" onclick="goBackFromWorkerHours()" class="px-5 py-2 bg-gray-500 text-white rounded-xl hover:bg-gray-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z" />
      </svg> Kembali </button> <button onclick="showPage('absensiPage')" class="px-5 py-2 bg-green-500 text-white rounded-xl hover:bg-green-600 transition-all font-medium flex items-center gap-2">
      <svg class="w-5 h-5" fill="white" viewbox="0 0 24 24">
       <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg> Back to Home </button>
    </div>
    <main class="flex-1 p-6 max-w-4xl mx-auto w-full">
     <h2 class="text-2xl font-bold text-white text-center mb-2">Recap Jam Kerja</h2>
     <p id="workerHoursDateLabel" class="text-center text-gray-300 mb-6"></p>
     <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
      <div class="relative"><input type="text" id="workerHoursSearch" placeholder="Cari nama pekerja..." class="w-full px-5 py-3 rounded-xl border-2 border-gray-300 focus:border-indigo-500 focus:outline-none transition-all text-gray-800 pl-12 bg-white">
       <svg class="absolute left-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
       </svg>
      </div>
     </div>
     <div id="workerHoursResults" class="space-y-4">
      <div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
       <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewbox="0 0 24 24">
        <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z" />
       </svg>
       <p>Ketik nama pekerja untuk melihat recap jam kerja</p>
      </div>
     </div>
    </main>
   </div><!-- STATUS CARD POPUP -->
   <div id="statusCardPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-md w-full max-h-[80%] overflow-hidden shadow-2xl fade-in">
     <div id="statusCardPopupHeader" class="px-6 py-4 flex items-center justify-between">
      <h3 id="statusCardPopupTitle" class="text-xl font-bold text-white">Daftar Pekerja</h3><button onclick="closeStatusCardPopup()" class="text-white hover:bg-white hover:bg-opacity-20 p-2 rounded-lg transition-all">
       <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
       </svg></button>
     </div>
     <div id="statusCardPopupContent" class="p-6 overflow-y-auto max-h-96">
     </div>
    </div>
   </div><!-- PHOTO VIEWER POPUP -->
   <div id="photoViewer" class="popup-overlay hidden"><button onclick="closePhotoViewer()" class="absolute top-4 right-4 bg-black bg-opacity-50 text-white w-10 h-10 rounded-full flex items-center justify-center z-10">
     <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
     </svg></button> <button onclick="prevPhoto()" class="nav-btn prev">
     <svg class="w-6 h-6" fill="white" viewbox="0 0 24 24">
      <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z" />
     </svg></button> <img id="viewerImage" src="" alt="Photo" class="popup-image"> <button onclick="nextPhoto()" class="nav-btn next">
     <svg class="w-6 h-6" fill="white" viewbox="0 0 24 24">
      <path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z" />
     </svg></button>
    <div id="photoViewerCounter" class="text-white mt-4 text-sm">
     1 / 1
    </div>
   </div><!-- Setup Guide Modal -->
   <div id="setupGuideModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden p-4">
    <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90%] overflow-auto">
     <div class="p-6">
      <div class="flex items-center justify-between mb-4">
       <h2 class="text-xl font-bold text-gray-800">Setup Google Integration</h2><button onclick="closeSetupGuide()" class="p-2 hover:bg-gray-100 rounded-lg">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg></button>
      </div>
      <div class="space-y-4 text-sm text-gray-700">
       <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
        <p class="font-semibold text-blue-800">Google Apps Script untuk Upload Foto &amp; Absensi</p>
        <p class="text-blue-700 text-xs mt-1">Copy kode di bawah ini ke Apps Script Anda</p>
       </div>
       <div class="bg-gray-900 text-green-400 p-3 rounded font-mono text-xs overflow-x-auto max-h-64">
        <pre id="appsScriptCode">// Google Apps Script for Absen Archipelago
const DRIVE_FOLDER_ID = '1CJ46h8M89mzc3XKEg-4hJPV-2voMN3OD';
const SPREADSHEET_ID = '1FllBcwBjTr_jfPylhyWwHt6ZE16j6fJpSa0C9hYEw44';

function doPost(e) {
  try {
    const data = JSON.parse(e.postData.contents);
    if (data.action === 'uploadPhoto') return uploadPhoto(data);
    if (data.action === 'submitAttendance') return submitAttendance(data);
    return jsonResponse({ success: false, error: 'Unknown action' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function doGet(e) {
  try {
    const action = e.parameter.action;
    if (action === 'getFolders') return getFolders();
    if (action === 'getPhotos') return getPhotos(e.parameter.folderId);
    if (action === 'getRecapData') return getRecapData();
    return jsonResponse({ status: 'OK' });
  } catch (error) {
    return jsonResponse({ success: false, error: error.toString() });
  }
}

function uploadPhoto(data) {
  const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const folderName = data.folderName;
  const fileName = data.fileName;
  const base64Data = data.photoData.split(',')[1];
  const blob = Utilities.newBlob(Utilities.base64Decode(base64Data), 'image/jpeg', fileName);
  
  let dateFolder;
  const folders = parentFolder.getFoldersByName(folderName);
  if (folders.hasNext()) dateFolder = folders.next();
  else dateFolder = parentFolder.createFolder(folderName);
  
  const file = dateFolder.createFile(blob);
  file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
  
  return jsonResponse({ success: true, fileId: file.getId() });
}

function submitAttendance(data) {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName('Absen recap');
  if (!sheet) sheet = ss.insertSheet('Absen recap');
  
  sheet.getRange('A1').setValue('Tanggal');
  sheet.getRange('A2').setValue('Jam');
  
  if (data.workers &amp;&amp; data.workers.length &gt; 0) {
    for (let i = 0; i &lt; data.workers.length; i++) {
      sheet.getRange(i + 3, 1).setValue(data.workers[i]);
    }
  }
  
  const lastCol = sheet.getLastColumn();
  const newCol = Math.max(lastCol + 1, 2);
  
  sheet.getRange(1, newCol).setValue(data.tanggal);
  sheet.getRange(2, newCol).setValue(data.jam);
  
  const colors = {
    'Start Work': '#22c55e', 'Finish Work': '#3b82f6',
    'Sakit': '#f97316', 'Standby': '#a855f7', 'Belum Absen': '#ef4444'
  };
  
  for (let j = 0; j &lt; data.attendance.length; j++) {
    const item = data.attendance[j];
    const cell = sheet.getRange(item.row, newCol);
    cell.setValue(item.status);
    cell.setBackground(colors[item.status] || '#ef4444');
    cell.setFontColor('#ffffff');
    cell.setHorizontalAlignment('center');
  }
  
  return jsonResponse({ success: true });
}

function getRecapData() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  const sheet = ss.getSheetByName('Absen recap');
  
  if (!sheet) {
    return jsonResponse({ success: true, data: [] });
  }
  
  const lastRow = sheet.getLastRow();
  const lastCol = sheet.getLastColumn();
  
  if (lastRow &lt; 3 || lastCol &lt; 2) {
    return jsonResponse({ success: true, data: [] });
  }
  
  const allData = sheet.getRange(1, 1, lastRow, lastCol).getValues();
  const result = [];
  
  for (let col = 1; col &lt; lastCol; col++) {
    const tanggal = allData[0][col];
    const jam = allData[1][col];
    
    if (!tanggal) continue;
    
    for (let row = 2; row &lt; lastRow; row++) {
      const workerName = allData[row][0];
      const status = allData[row][col];
      
      if (workerName &amp;&amp; status) {
        result.push({
          date: tanggal,
          time: jam || '',
          worker_name: workerName,
          status: status
        });
      }
    }
  }
  
  return jsonResponse({ success: true, data: result });
}

function getFolders() {
  const parentFolder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
  const folders = parentFolder.getFolders();
  const result = [];
  while (folders.hasNext()) {
    const folder = folders.next();
    result.push({ id: folder.getId(), name: folder.getName() });
  }
  result.sort((a, b) =&gt; b.name.localeCompare(a.name));
  return jsonResponse({ success: true, folders: result });
}

function getPhotos(folderId) {
  const folder = DriveApp.getFolderById(folderId);
  const files = folder.getFiles();
  const result = [];
  while (files.hasNext()) {
    const file = files.next();
    if (file.getMimeType().startsWith('image/')) {
      result.push({
        id: file.getId(), name: file.getName(),
        thumbnailUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&amp;sz=w200',
        fullUrl: 'https://drive.google.com/thumbnail?id=' + file.getId() + '&amp;sz=w1920'
      });
    }
  }
  result.sort((a, b) =&gt; a.name.localeCompare(b.name));
  return jsonResponse({ success: true, photos: result });
}

function jsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}</pre>
       </div><button onclick="copyAppsScript()" class="mt-2 px-4 py-2 bg-indigo-500 text-white rounded text-sm hover:bg-indigo-600"> Copy Kode </button>
       <div class="mt-4"><label class="block text-sm font-medium text-gray-700 mb-2">URL Web App:</label> <input type="text" id="scriptUrlInput" placeholder="https://script.google.com/macros/s/..." class="w-full px-3 py-2 border-2 border-gray-200 rounded-lg text-sm focus:border-indigo-500 focus:outline-none"> <button onclick="saveScriptUrl()" class="mt-2 px-4 py-2 bg-green-500 text-white rounded-lg text-sm font-medium hover:bg-green-600"> Simpan URL </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Toast -->
   <div id="toast" class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-xl shadow-xl hidden z-50"><span id="toastMessage">Berhasil!</span>
   </div>
  </div>
  <script>
    // ==================== CONFIG & STATE ====================
    const defaultConfig = {
      app_title: 'ABSEN ONLINE DAILY WORKER I.B.L.',
      company_name: 'ARCHIPELAGO DAILY WORKER'
    };

    let config = { ...defaultConfig };
    let allAbsensiData = [];
    let calendarDate = new Date();

    let workers = [];
    let workerStatus = {};
    
    let capturedPhotos = [];
    let currentViewerIndex = 0;
    let currentViewerPhotos = [];
    
    let currentLocation = null;
    let locationAddress = 'Mendapatkan lokasi...';
    
    const SHEET_ID = '1FllBcwBjTr_jfPylhyWwHt6ZE16j6fJpSa0C9hYEw44';
    const SHEET_NAME = 'Form responses 1';
    const SHEETS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}`;
    
    const RECAP_SHEET_NAME = 'Absen recap';
    const RECAP_SHEETS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(RECAP_SHEET_NAME)}`;
    
    const WATERMARK_LOGO_URL = 'https://lh3.googleusercontent.com/d/1zaavYZSem-yNHztE724qeIAWw9uGJgen=s200';
    
    let GOOGLE_SCRIPT_URL = localStorage.getItem('googleScriptUrl') || 'https://script.google.com/macros/s/AKfycbzTjKB4lTiZKafD34Ts-NWEC-qq6RTAYudu_r4X8eijJSDCUzz1RvRY1a4S2XTENBHxjQ/exec';

    let watermarkLogoLoaded = null;
    
    // Variable untuk menyimpan tanggal recap saat ini
    let currentStatusCardDate = '';
    
    function preloadWatermarkLogo() {
      return new Promise((resolve) => {
        if (watermarkLogoLoaded) {
          resolve(watermarkLogoLoaded);
          return;
        }
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => {
          watermarkLogoLoaded = img;
          resolve(img);
        };
        img.onerror = () => resolve(null);
        img.src = WATERMARK_LOGO_URL;
        setTimeout(() => resolve(watermarkLogoLoaded), 2000);
      });
    }
    
    preloadWatermarkLogo();

    // ==================== FETCH RECAP DATA FROM GOOGLE SHEETS ====================
    async function fetchRecapDataFromSheet() {
      try {
        const response = await fetch(RECAP_SHEETS_URL);
        const text = await response.text();
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
        
        if (!jsonMatch) {
          console.log('No recap data found or sheet empty');
          return [];
        }
        
        const data = JSON.parse(jsonMatch[1]);
        const rows = data.table.rows;
        const cols = data.table.cols;
        
        if (!rows || rows.length < 3) {
          console.log('Not enough data in recap sheet');
          return [];
        }
        
        const result = [];
        
        const tanggalRow = rows[0];
        const jamRow = rows[1];
        
        const numCols = cols.length;
        
        for (let col = 1; col < numCols; col++) {
          const tanggalCell = tanggalRow.c && tanggalRow.c[col];
          const jamCell = jamRow.c && jamRow.c[col];
          
          let tanggal = tanggalCell ? (tanggalCell.v || tanggalCell.f || '') : '';
          let jam = jamCell ? (jamCell.v || jamCell.f || '') : '';
          
          if (!tanggal) continue;
          
          const displayDate = String(tanggal);
          const dateForComparison = convertToIdLocaleDate(displayDate);
          
          for (let row = 2; row < rows.length; row++) {
            const workerRow = rows[row];
            if (!workerRow.c) continue;
            
            const workerNameCell = workerRow.c[0];
            const statusCell = workerRow.c[col];
            
            const workerName = workerNameCell ? (workerNameCell.v || workerNameCell.f || '') : '';
            const status = statusCell ? (statusCell.v || statusCell.f || '') : '';
            
            if (workerName && status) {
              result.push({
                type: 'attendance',
                date: dateForComparison,
                date_display: displayDate,
                time: String(jam),
                worker_name: String(workerName),
                status: String(status)
              });
            }
          }
        }
        
        console.log(`Loaded ${result.length} attendance records from Google Sheets`);
        return result;
        
      } catch (error) {
        console.error('Error fetching recap data:', error);
        return [];
      }
    }

    function convertToIdLocaleDate(dateStr) {
      if (!dateStr) return '';
      
      const str = String(dateStr).trim();
      
      const monthMapId = {
        'januari': 0, 'februari': 1, 'maret': 2, 'april': 3,
        'mei': 4, 'juni': 5, 'juli': 6, 'agustus': 7,
        'september': 8, 'oktober': 9, 'november': 10, 'desember': 11
      };
      
      const monthMapEn = {
        'january': 0, 'february': 1, 'march': 2, 'april': 3,
        'may': 4, 'june': 5, 'july': 6, 'august': 7,
        'september': 8, 'october': 9, 'november': 10, 'december': 11
      };
      
      const match = str.match(/(\d{1,2})\s+(\w+)\s+(\d{4})/i);
      if (match) {
        const day = parseInt(match[1]);
        const monthName = match[2].toLowerCase();
        const year = parseInt(match[3]);
        
        let monthIndex = -1;
        if (monthMapId.hasOwnProperty(monthName)) {
          monthIndex = monthMapId[monthName];
        } else if (monthMapEn.hasOwnProperty(monthName)) {
          monthIndex = monthMapEn[monthName];
        }
        
        if (monthIndex >= 0) {
          const date = new Date(year, monthIndex, day);
          return date.toLocaleDateString('id-ID');
        }
      }
      
      return str;
    }

    // ==================== LOCATION ====================
    function getCurrentLocation() {
      updateLocationUI('loading', 'Mendapatkan lokasi...');
      
      if (!navigator.geolocation) {
        updateLocationUI('error', 'Geolokasi tidak didukung');
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        async (position) => {
          currentLocation = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          };
          
          try {
            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${currentLocation.lat}&lon=${currentLocation.lng}&zoom=18&addressdetails=1`);
            const data = await response.json();
            
            if (data && data.display_name) {
              const parts = data.display_name.split(',');
              const filteredParts = parts.filter(p => !p.trim().toLowerCase().includes('indonesia'));
              locationAddress = filteredParts.join(',').trim();
            } else {
              locationAddress = `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
            }
          } catch (error) {
            locationAddress = `${currentLocation.lat.toFixed(6)}, ${currentLocation.lng.toFixed(6)}`;
          }
          
          updateLocationUI('success', locationAddress);
        },
        (error) => {
          let errorMsg = 'Gagal mendapatkan lokasi';
          if (error.code === 1) errorMsg = 'Akses lokasi ditolak';
          else if (error.code === 2) errorMsg = 'Lokasi tidak tersedia';
          else if (error.code === 3) errorMsg = 'Timeout mendapatkan lokasi';
          
          updateLocationUI('error', errorMsg);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 60000
        }
      );
    }
    
    function updateLocationUI(status, text) {
      const icon = document.getElementById('locationIcon');
      const textEl = document.getElementById('locationText');
      const banner = document.getElementById('locationBanner');
      
      if (!textEl || !icon || !banner) return;
      
      textEl.textContent = text;
      
      if (status === 'loading') {
        icon.textContent = '';
        banner.className = 'bg-white rounded-xl p-3 mb-4 flex items-center justify-between';
      } else if (status === 'success') {
        icon.textContent = '';
        banner.className = 'bg-green-50 border border-green-200 rounded-xl p-3 mb-4 flex items-center justify-between';
        textEl.className = 'text-sm text-green-700';
      } else if (status === 'error') {
        icon.textContent = '';
        banner.className = 'bg-red-50 border border-red-200 rounded-xl p-3 mb-4 flex items-center justify-between';
        textEl.className = 'text-sm text-red-600';
      }
    }
    
    function refreshLocation() {
      getCurrentLocation();
    }

    // ==================== PHOTO UPLOAD HANDLER ====================
    async function handlePhotoUpload(event) {
      const files = event.target.files;
      if (!files || files.length === 0) return;
      
      const promises = Array.from(files).map(file => 
        processPhotoWithWatermark(file).then(photo => {
          capturedPhotos.push(photo);
        }).catch(() => {})
      );
      
      await Promise.all(promises);
      renderPhotoThumbnails();
      
      event.target.value = '';
    }

    async function processPhotoWithWatermark(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          const img = new Image();
          
          img.onload = async () => {
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            
            ctx.drawImage(img, 0, 0);
            
            await addWatermark(ctx, canvas.width, canvas.height, locationAddress);
            
            const fullData = canvas.toDataURL('image/jpeg', 0.92);
            
            const thumbCanvas = document.createElement('canvas');
            const maxThumbSize = 200;
            const ratio = Math.min(maxThumbSize / img.width, maxThumbSize / img.height);
            thumbCanvas.width = img.width * ratio;
            thumbCanvas.height = img.height * ratio;
            const thumbCtx = thumbCanvas.getContext('2d');
            thumbCtx.drawImage(canvas, 0, 0, thumbCanvas.width, thumbCanvas.height);
            
            resolve({
              thumbnail: thumbCanvas.toDataURL('image/jpeg', 0.5),
              fullData: fullData,
              timestamp: new Date()
            });
          };
          
          img.onerror = () => reject(new Error('Failed to load image'));
          img.src = e.target.result;
        };
        
        reader.onerror = () => reject(new Error('Failed to read file'));
        reader.readAsDataURL(file);
      });
    }

    async function addWatermark(ctx, width, height, locationStr) {
      const now = new Date();
      const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      
      const dayName = days[now.getDay()];
      const day = now.getDate();
      const month = months[now.getMonth()];
      const year = now.getFullYear();
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      
      const dateStr = `${day} ${month} ${year}`;
      const timeStr = `${hours}:${minutes}`;
      
      const baseSize = Math.min(width, height);
      const scale = baseSize / 1080;
      
      const padding = 50 * scale;
      const logoSize = 200 * scale;
      const fontSize = 38 * scale;
      const lineHeight = 45 * scale;
      const logoToTimeGap = 12 * scale;
      const timeToLocGap = 8 * scale;
      const cornerRadius = 20 * scale;
      
      ctx.shadowColor = 'rgba(0, 0, 0, 0.8)';
      ctx.shadowBlur = 10 * scale;
      ctx.shadowOffsetX = 3 * scale;
      ctx.shadowOffsetY = 3 * scale;
      
      const startX = padding;
      const bottomY = height - padding;
      
      let locationY = bottomY;
      const maxLocationWidth = width * 0.5;
      
      if (locationStr && locationStr !== 'Mendapatkan lokasi...' && !locationStr.includes('Gagal') && !locationStr.includes('ditolak')) {
        ctx.font = `${fontSize * 0.65}px Poppins, sans-serif`;
        ctx.fillStyle = '#ffffff';
        
        const words = locationStr.split(' ');
        let lines = [];
        let currentLine = ' ';
        
        words.forEach(word => {
          const testLine = currentLine + word + ' ';
          const testWidth = ctx.measureText(testLine).width;
          if (testWidth > maxLocationWidth && currentLine !== ' ') {
            lines.push(currentLine.trim());
            currentLine = '   ' + word + ' ';
          } else {
            currentLine = testLine;
          }
        });
        lines.push(currentLine.trim());
        
        const locLineHeight = fontSize * 0.85;
        for (let i = lines.length - 1; i >= 0; i--) {
          ctx.fillText(lines[i], startX, locationY);
          locationY -= locLineHeight;
        }
        locationY -= timeToLocGap;
      }
      
      const row2Y = locationY;
      
      ctx.font = `bold ${fontSize * 1.5}px Poppins, sans-serif`;
      ctx.fillStyle = '#f59e0b';
      ctx.fillText(timeStr, startX, row2Y);
      
      const timeWidth = ctx.measureText(timeStr).width;
      const lineX = startX + timeWidth + fontSize * 0.5;
      
      ctx.strokeStyle = '#f59e0b';
      ctx.lineWidth = 3 * scale;
      ctx.beginPath();
      ctx.moveTo(lineX, row2Y - fontSize * 1.2);
      ctx.lineTo(lineX, row2Y + fontSize * 0.3);
      ctx.stroke();
      
      const textStartX = lineX + fontSize * 0.5;
      ctx.font = `bold ${fontSize * 0.85}px Poppins, sans-serif`;
      ctx.fillStyle = '#ffffff';
      ctx.fillText(dateStr, textStartX, row2Y - fontSize * 0.5);
      
      ctx.font = `${fontSize * 0.75}px Poppins, sans-serif`;
      ctx.fillStyle = '#ffffff';
      ctx.fillText(dayName, textStartX, row2Y + fontSize * 0.2);
      
      const logoY = row2Y - fontSize * 1.5 - logoToTimeGap - logoSize;
      const logoImg = await preloadWatermarkLogo();
      if (logoImg && logoImg.complete && logoImg.naturalWidth > 0) {
        ctx.save();
        ctx.beginPath();
        ctx.moveTo(startX + cornerRadius, logoY);
        ctx.lineTo(startX + logoSize - cornerRadius, logoY);
        ctx.quadraticCurveTo(startX + logoSize, logoY, startX + logoSize, logoY + cornerRadius);
        ctx.lineTo(startX + logoSize, logoY + logoSize - cornerRadius);
        ctx.quadraticCurveTo(startX + logoSize, logoY + logoSize, startX + logoSize - cornerRadius, logoY + logoSize);
        ctx.lineTo(startX + cornerRadius, logoY + logoSize);
        ctx.quadraticCurveTo(startX, logoY + logoSize, startX, logoY + logoSize - cornerRadius);
        ctx.lineTo(startX, logoY + cornerRadius);
        ctx.quadraticCurveTo(startX, logoY, startX + cornerRadius, logoY);
        ctx.closePath();
        ctx.clip();
        ctx.drawImage(logoImg, startX, logoY, logoSize, logoSize);
        ctx.restore();
      }
      
      const rightPadding = padding;
      const topY = padding + fontSize;
      
      ctx.font = `bold ${fontSize * 1.2}px Poppins, sans-serif`;
      const timeText = 'Time';
      const markText = 'mark';
      const timeTextWidth = ctx.measureText(timeText).width;
      const markWidth = ctx.measureText(markText).width;
      const totalTextWidth = timeTextWidth + markWidth;
      
      const rightX = width - rightPadding - totalTextWidth;
      
      ctx.fillStyle = '#f59e0b';
      ctx.fillText(timeText, rightX, topY);
      
      ctx.fillStyle = '#ffffff';
      ctx.fillText(markText, rightX + timeTextWidth, topY);
      
      ctx.font = `${fontSize * 0.7}px Poppins, sans-serif`;
      ctx.fillStyle = '#ffffff';
      const verifiedText = '100% photo verified';
      ctx.fillText(verifiedText, rightX, topY + lineHeight * 0.7);
      
      ctx.shadowColor = 'transparent';
      ctx.shadowBlur = 0;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }

    function renderPhotoThumbnails() {
      const container = document.getElementById('photoThumbnails');
      const countEl = document.getElementById('photoCount');
      
      if (capturedPhotos.length === 0) {
        container.classList.add('hidden');
        countEl.classList.add('hidden');
        return;
      }
      
      container.classList.remove('hidden');
      countEl.classList.remove('hidden');
      countEl.textContent = `${capturedPhotos.length} foto dipilih`;
      
      container.innerHTML = capturedPhotos.map((photo, index) => `
        <div class="relative">
          <img src="${photo.thumbnail}" class="photo-thumbnail" onclick="openPhotoViewer(${index}, 'captured')">
          <button onclick="removePhoto(${index})" class="absolute -top-2 -right-2 bg-red-500 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs hover:bg-red-600"></button>
        </div>
      `).join('');
    }

    function removePhoto(index) {
      capturedPhotos.splice(index, 1);
      renderPhotoThumbnails();
    }

    // ==================== PHOTO VIEWER ====================
    function openPhotoViewer(index, source) {
      if (source === 'captured') {
        currentViewerPhotos = capturedPhotos.map(p => p.fullData);
      } else {
        currentViewerPhotos = source;
      }
      
      currentViewerIndex = index;
      updatePhotoViewer();
      document.getElementById('photoViewer').classList.remove('hidden');
    }

    function updatePhotoViewer() {
      document.getElementById('viewerImage').src = currentViewerPhotos[currentViewerIndex];
      document.getElementById('photoViewerCounter').textContent = `${currentViewerIndex + 1} / ${currentViewerPhotos.length}`;
    }

    function prevPhoto() {
      if (currentViewerIndex > 0) {
        currentViewerIndex--;
        updatePhotoViewer();
      }
    }

    function nextPhoto() {
      if (currentViewerIndex < currentViewerPhotos.length - 1) {
        currentViewerIndex++;
        updatePhotoViewer();
      }
    }

    function closePhotoViewer() {
      document.getElementById('photoViewer').classList.add('hidden');
    }

    // ==================== DRIVE INTEGRATION ====================
    async function uploadPhotoToDrive(photoData, timestamp) {
      if (!GOOGLE_SCRIPT_URL) return null;
      
      const now = timestamp || new Date();
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const folderName = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const fileName = `Absen, ${hours}:${minutes}.jpg`;
      
      try {
        await fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'uploadPhoto',
            folderName: folderName,
            fileName: fileName,
            photoData: photoData
          })
        });
        return { success: true };
      } catch (error) {
        return null;
      }
    }

    async function fetchPhotoFolders() {
      if (!GOOGLE_SCRIPT_URL) return [];
      try {
        // Timeout 8 detik untuk fetch folders
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 8000);
        
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getFolders`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        const data = await response.json();
        return data.success ? data.folders : [];
      } catch (error) {
        console.log('Fetch folders timeout/error:', error.message);
        return [];
      }
    }

    async function fetchPhotosFromFolder(folderId) {
      if (!GOOGLE_SCRIPT_URL) return [];
      try {
        // Timeout 10 detik untuk fetch photos
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=getPhotos&folderId=${folderId}`, {
          signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        const data = await response.json();
        return data.success ? data.photos : [];
      } catch (error) {
        console.log('Fetch photos timeout/error:', error.message);
        return [];
      }
    }

    // ==================== PHOTO RECAP ====================
    let cachedFolders = null;
    let cachedPhotos = {};
    
    async function showPhotoRecap() {
      showPage('photoFoldersPage');
      
      // Tampilkan cache dulu jika ada (instant load)
      if (cachedFolders && cachedFolders.length > 0) {
        document.getElementById('photoFoldersLoading').classList.add('hidden');
        renderPhotoFolders(cachedFolders);
        // Background refresh tanpa blocking
        fetchPhotoFolders().then(folders => {
          if (folders && folders.length > 0) {
            cachedFolders = folders;
            renderPhotoFolders(folders);
          }
        });
        return;
      }
      
      // Tampilkan loading indicator
      document.getElementById('photoFolders').classList.add('hidden');
      document.getElementById('noPhotosMessage').classList.add('hidden');
      document.getElementById('photoFoldersLoading').classList.remove('hidden');
      
      const folders = await fetchPhotoFolders();
      cachedFolders = folders;
      renderPhotoFolders(folders);
    }
    
    function renderPhotoFolders(folders) {
      document.getElementById('photoFoldersLoading').classList.add('hidden');
      
      if (folders.length === 0) {
        document.getElementById('noPhotosMessage').classList.remove('hidden');
        return;
      }
      
      const container = document.getElementById('photoFolders');
      container.classList.remove('hidden');
      container.innerHTML = folders.map(folder => `
        <button onclick="openPhotoFolder('${folder.id}', '${folder.name}')" class="photo-folder bg-white rounded-2xl p-6 shadow-lg text-center">
          <svg class="w-12 h-12 mx-auto mb-3" fill="#1e3a5f" viewBox="0 0 24 24"><path d="M10 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2h-8l-2-2z"/></svg>
          <h3 class="font-semibold text-gray-800">${folder.name}</h3>
        </button>
      `).join('');
    }

    async function openPhotoFolder(folderId, folderName) {
      showPage('photoGalleryPage');
      document.getElementById('galleryTitle').textContent = `Foto: ${folderName}`;
      
      // Tampilkan cache dulu jika ada (instant load)
      if (cachedPhotos[folderId] && cachedPhotos[folderId].length > 0) {
        document.getElementById('photoGalleryLoading').classList.add('hidden');
        document.getElementById('photoGallery').classList.remove('hidden');
        renderPhotoGallery(cachedPhotos[folderId]);
        // Background refresh tanpa blocking
        fetchPhotosFromFolder(folderId).then(photos => {
          if (photos && photos.length > 0) {
            cachedPhotos[folderId] = photos;
            renderPhotoGallery(photos);
          }
        });
        return;
      }
      
      // Tampilkan loading indicator, sembunyikan gallery
      document.getElementById('photoGallery').classList.add('hidden');
      document.getElementById('photoGalleryLoading').classList.remove('hidden');
      
      const photos = await fetchPhotosFromFolder(folderId);
      
      // Sembunyikan loading, tampilkan gallery
      document.getElementById('photoGalleryLoading').classList.add('hidden');
      document.getElementById('photoGallery').classList.remove('hidden');
      
      cachedPhotos[folderId] = photos;
      renderPhotoGallery(photos);
    }
    
    function renderPhotoGallery(photos) {
      document.getElementById('photoGalleryLoading').classList.add('hidden');
      
      if (photos.length === 0) {
        document.getElementById('photoGallery').innerHTML = '<p class="col-span-full text-center text-gray-300 py-8">Tidak ada foto di folder ini</p>';
        return;
      }
      
      const container = document.getElementById('photoGallery');
      container.innerHTML = photos.map((photo, index) => `
        <div class="gallery-photo rounded-xl overflow-hidden shadow-lg cursor-pointer" onclick="viewGalleryPhoto(${index})">
          <img src="${photo.thumbnailUrl}" alt="Foto" class="w-full h-32 object-cover">
        </div>
      `).join('');
      
      window.galleryPhotos = photos.map(p => p.fullUrl);
    }

    function viewGalleryPhoto(index) {
      if (window.galleryPhotos) {
        openPhotoViewer(index, window.galleryPhotos);
      }
    }

    // ==================== WORKERS ====================
    function convertDriveUrl(url) {
      if (!url) return '';
      let match = url.match(/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
      if (match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w200`;
      match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
      if (match) return `https://drive.google.com/thumbnail?id=${match[1]}&sz=w200`;
      return url;
    }

    async function fetchWorkersFromSheet() {
      try {
        const response = await fetch(SHEETS_URL);
        const text = await response.text();
        const jsonMatch = text.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);?$/);
        if (!jsonMatch) throw new Error('Parse error');
        
        const data = JSON.parse(jsonMatch[1]);
        const rows = data.table.rows;
        
        workers = [];
        for (let i = 0; i < rows.length; i++) {
          const row = rows[i];
          if (row.c && row.c[1] && row.c[1].v) {
            workers.push({
              id: i + 1,
              name: row.c[1].v,
              photo: row.c[2] && row.c[2].v ? convertDriveUrl(row.c[2].v) : ''
            });
          }
        }
        
        workers.forEach(w => workerStatus[w.id] = null);
        return true;
      } catch (error) {
        return false;
      }
    }

    function getUserIcon(size = 40) {
      return `<svg width="${size}" height="${size}" fill="#1e3a5f" viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>`;
    }

    function getWorkerPhotoHtml(worker, size = 60) {
      if (worker.photo) {
        return `<img src="${worker.photo}" alt="${worker.name}" class="worker-photo-img" style="width:${size}px;height:${size}px;" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                <div style="display:none;width:${size}px;height:${size}px;border-radius:12px;" class="flex items-center justify-center bg-gray-200">${getUserIcon(size * 0.6)}</div>`;
      }
      return `<div class="flex items-center justify-center bg-gray-200" style="width:${size}px;height:${size}px;border-radius:12px;">${getUserIcon(size * 0.6)}</div>`;
    }

    function updateStatusCounter() {
      const selectedCount = Object.values(workerStatus).filter(s => s !== null).length;
      document.getElementById('selectedCount').textContent = selectedCount;
      document.getElementById('unselectedCount').textContent = workers.length - selectedCount;
    }

    function renderWorkerGrid(filteredWorkers = workers) {
      const grid = document.getElementById('workerGrid');
      document.getElementById('loadingWorkers').classList.add('hidden');
      grid.classList.remove('hidden');
      grid.innerHTML = '';
      updateStatusCounter();
      
      if (filteredWorkers.length === 0) {
        grid.innerHTML = `<div class="col-span-full text-center py-12 text-white"><p>Tidak ada data pekerja</p></div>`;
        return;
      }
      
      filteredWorkers.forEach(worker => {
        const status = workerStatus[worker.id];
        const isSelected = status !== null;
        
        const card = document.createElement('div');
        card.className = `worker-card bg-white rounded-2xl p-4 shadow-lg transition-all cursor-pointer ${isSelected ? 'selected' : ''}`;
        card.dataset.workerId = worker.id;
        
        const getStatusBtnClass = (btnStatus, color) => {
          const isActive = status === btnStatus;
          return `status-btn px-2 py-1 ${color} text-white rounded-lg text-xs ${isActive ? 'selected font-bold' : 'font-medium'} hover:opacity-80`;
        };
        
        card.innerHTML = `
          <div class="text-center mb-3">
            <div class="mb-2 flex justify-center">${getWorkerPhotoHtml(worker, 60)}</div>
            <h3 class="worker-name font-semibold text-gray-800 text-sm">${worker.name}</h3>
            <p class="status-text text-xs mt-1 ${status ? 'text-gray-600' : 'text-gray-400'}">${status || 'Belum dipilih'}</p>
          </div>
          <div class="grid grid-cols-2 gap-1">
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Start Work')" class="${getStatusBtnClass('Start Work', 'bg-green-500')} whitespace-nowrap text-[10px]">Start Work</button>
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Finish Work')" class="${getStatusBtnClass('Finish Work', 'bg-blue-500')} whitespace-nowrap text-[10px]">Finish Work</button>
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Sakit')" class="${getStatusBtnClass('Sakit', 'bg-orange-500')} text-[10px]">Sakit</button>
            <button onclick="event.stopPropagation(); toggleStatus(${worker.id}, 'Standby')" class="${getStatusBtnClass('Standby', 'bg-purple-500')} text-[10px]">Standby</button>
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    function toggleStatus(workerId, status) {
      workerStatus[workerId] = workerStatus[workerId] === status ? null : status;
      renderWorkerGrid();
    }

    function setAllPresent() {
      workers.forEach(w => workerStatus[w.id] = 'Start Work');
      renderWorkerGrid();
      showToast('Semua pekerja ditandai hadir!');
    }

    function resetAllStatus() {
      workers.forEach(w => workerStatus[w.id] = null);
      renderWorkerGrid();
      showToast('Status absen direset!');
    }
    
    function resetAllStatusSilent() {
      workers.forEach(w => workerStatus[w.id] = null);
      renderWorkerGrid();
    }

    // ==================== SEARCH ====================
    document.getElementById('searchInput').addEventListener('input', function(e) {
      const query = e.target.value.toLowerCase().trim();
      
      if (query === '') {
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workerGrid').classList.remove('hidden');
        return;
      }
      
      const filtered = workers.filter(w => w.name.toLowerCase().includes(query));
      
      if (filtered.length > 0) {
        document.getElementById('workerGrid').classList.add('hidden');
        document.getElementById('searchResults').classList.remove('hidden');
        renderSearchResults(filtered);
      } else {
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workerGrid').classList.remove('hidden');
      }
    });

    function renderSearchResults(filteredWorkers) {
      const container = document.getElementById('searchResultsGrid');
      container.innerHTML = '';
      
      filteredWorkers.forEach(worker => {
        const status = workerStatus[worker.id];
        const isSelected = status !== null;
        
        const getStatusBtnClass = (btnStatus, color) => {
          const isActive = status === btnStatus;
          return `status-btn px-2 py-1 ${color} text-white rounded-lg text-xs ${isActive ? 'selected font-bold' : 'font-medium'} hover:opacity-80`;
        };
        
        const card = document.createElement('div');
        card.className = `worker-card bg-white rounded-2xl p-4 shadow-lg transition-all cursor-pointer fade-in ${isSelected ? 'selected' : ''}`;
        
        card.innerHTML = `
          <div class="text-center mb-3">
            <div class="mb-2 flex justify-center">${getWorkerPhotoHtml(worker, 60)}</div>
            <h3 class="worker-name font-semibold text-gray-800 text-sm">${worker.name}</h3>
            <p class="status-text text-xs mt-1 ${status ? 'text-gray-600' : 'text-gray-400'}">${status || 'Belum dipilih'}</p>
          </div>
          <div class="grid grid-cols-2 gap-1">
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Start Work')" class="${getStatusBtnClass('Start Work', 'bg-green-500')} whitespace-nowrap text-[10px]">Start Work</button>
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Finish Work')" class="${getStatusBtnClass('Finish Work', 'bg-blue-500')} whitespace-nowrap text-[10px]">Finish Work</button>
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Sakit')" class="${getStatusBtnClass('Sakit', 'bg-orange-500')} text-[10px]">Sakit</button>
            <button onclick="event.stopPropagation(); setStatus(${worker.id}, 'Standby')" class="${getStatusBtnClass('Standby', 'bg-purple-500')} text-[10px]">Standby</button>
          </div>
        `;
        
        container.appendChild(card);
      });
    }

    function setStatus(workerId, status) {
      workerStatus[workerId] = workerStatus[workerId] === status ? null : status;
      
      setTimeout(() => {
        document.getElementById('searchInput').value = '';
        document.getElementById('searchResults').classList.add('hidden');
        document.getElementById('workerGrid').classList.remove('hidden');
        renderWorkerGrid();
      }, 500);
    }

    // ==================== SUBMIT ====================
    
    // Deteksi iOS device
    function isIOSDevice() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) || 
             (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
    }
    
    // Konversi base64 ke Blob
    function base64ToBlob(base64Data, contentType = 'image/jpeg') {
      const byteString = atob(base64Data.split(',')[1]);
      const arrayBuffer = new ArrayBuffer(byteString.length);
      const uint8Array = new Uint8Array(arrayBuffer);
      
      for (let i = 0; i < byteString.length; i++) {
        uint8Array[i] = byteString.charCodeAt(i);
      }
      
      return new Blob([uint8Array], { type: contentType });
    }
    
    // Download foto untuk Android & Desktop
    function downloadPhoto(photoData, fileName) {
      const link = document.createElement('a');
      link.href = photoData;
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    // Share foto untuk iOS menggunakan Web Share API
    async function sharePhotoIOS(photoData, fileName) {
      try {
        const blob = base64ToBlob(photoData);
        const file = new File([blob], fileName, { type: 'image/jpeg' });
        
        if (navigator.canShare && navigator.canShare({ files: [file] })) {
          await navigator.share({
            files: [file],
            title: 'Foto Absensi',
            text: `Foto absensi - ${fileName}`
          });
          return true;
        } else {
          // Fallback jika Web Share API tidak support files
          downloadPhoto(photoData, fileName);
          return true;
        }
      } catch (error) {
        if (error.name === 'AbortError') {
          // User cancelled share
          console.log('Share dibatalkan oleh user');
          return true;
        }
        console.error('Error sharing:', error);
        // Fallback ke download biasa
        downloadPhoto(photoData, fileName);
        return true;
      }
    }
    
    // Download/Share semua foto
    async function downloadOrSharePhotos(photos, baseFileName) {
      if (photos.length === 0) return;
      
      const isIOS = isIOSDevice();
      
      for (let i = 0; i < photos.length; i++) {
        const photo = photos[i];
        const fileName = photos.length === 1 
          ? `${baseFileName}.jpg` 
          : `${baseFileName}_${i + 1}.jpg`;
        
        if (isIOS) {
          // iOS: Gunakan Share Sheet
          await sharePhotoIOS(photo.fullData, fileName);
          // Tunggu sebentar antar foto untuk iOS
          if (i < photos.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        } else {
          // Android & Desktop: Download langsung
          downloadPhoto(photo.fullData, fileName);
          // Delay kecil antar download untuk mencegah browser block
          if (i < photos.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 300));
          }
        }
      }
    }
    
    async function submitAbsensi() {
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<div class="animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div> Mengirim...';
      
      const now = new Date();
      const monthsId = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      const tanggalFormatted = `${now.getDate()} ${monthsId[now.getMonth()]} ${now.getFullYear()}`;
      const jamFormatted = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      const attendanceData = workers.map((worker, index) => ({
        row: index + 3,
        status: workerStatus[worker.id] || 'Belum Absen'
      }));
      
      const isIOS = isIOSDevice();
      const photosToProcess = [...capturedPhotos]; // Copy untuk proses nanti
      const baseFileName = `Absen_${tanggalFormatted.replace(/ /g, '_')}_${jamFormatted.replace(':', '-')}`;
      
      // PARALLEL UPLOAD: Upload foto & kirim data absensi secara bersamaan
      const uploadPromises = [];
      
      // Promise untuk upload foto ke Drive (parallel)
      if (GOOGLE_SCRIPT_URL && photosToProcess.length > 0) {
        submitBtn.innerHTML = `<div class="animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div> Mengupload ${photosToProcess.length} foto...`;
        
        // Upload semua foto secara parallel (lebih cepat)
        photosToProcess.forEach((photo, i) => {
          uploadPromises.push(
            uploadPhotoToDriveFast(photo.fullData, photo.timestamp, i)
              .then(() => console.log(` Foto ${i + 1} uploaded`))
              .catch(err => console.error(` Foto ${i + 1} gagal:`, err))
          );
        });
      }
      
      // Promise untuk kirim data absensi
      if (GOOGLE_SCRIPT_URL) {
        uploadPromises.push(
          fetch(GOOGLE_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'submitAttendance',
              tanggal: tanggalFormatted,
              jam: jamFormatted,
              workers: workers.map(w => w.name),
              attendance: attendanceData
            })
          }).then(() => console.log(' Data absensi terkirim'))
            .catch(err => console.error(' Error absensi:', err))
        );
      }
      
      // Tunggu semua upload selesai (parallel = lebih cepat)
      if (uploadPromises.length > 0) {
        submitBtn.innerHTML = '<div class="animate-spin w-6 h-6 border-2 border-white border-t-transparent rounded-full"></div> Memproses...';
        await Promise.all(uploadPromises);
      }
      
      console.log(' Semua data berhasil dikirim!');
      
      // Reset form dulu, baru show toast
      resetAllStatusSilent();
      capturedPhotos = [];
      renderPhotoThumbnails();
      
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<svg class="w-6 h-6 transform -rotate-45" fill="white" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg> Kirim Absensi';
      
      // SETELAH semua selesai, baru download/share foto ke device
      if (photosToProcess.length > 0) {
        showToast(` Absensi & ${photosToProcess.length} foto berhasil dikirim!`);
        
        // Delay sedikit biar toast muncul dulu
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Download/Share foto
        await downloadOrSharePhotos(photosToProcess, baseFileName);
        
        if (isIOS) {
          showToast(' Silakan simpan foto dari Share Sheet');
        }
      } else {
        showToast(' Absensi berhasil dikirim!');
      }
    }
    
    // Fungsi upload foto yang cepat (parallel-friendly, timeout pendek)
    async function uploadPhotoToDriveFast(photoData, timestamp, index = 0) {
      if (!GOOGLE_SCRIPT_URL) return null;
      
      const now = timestamp || new Date();
      const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
      const folderName = `${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()}`;
      const hours = String(now.getHours()).padStart(2, '0');
      const minutes = String(now.getMinutes()).padStart(2, '0');
      const seconds = String(now.getSeconds()).padStart(2, '0');
      const ms = String(now.getMilliseconds()).padStart(3, '0');
      const fileName = `Absen_${hours}-${minutes}-${seconds}_${index}.jpg`;
      
      // Fire and forget dengan timeout pendek (5 detik)
      return new Promise((resolve) => {
        const timeoutId = setTimeout(() => resolve({ success: true }), 5000);
        
        fetch(GOOGLE_SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'uploadPhoto',
            folderName: folderName,
            fileName: fileName,
            photoData: photoData
          })
        })
        .then(() => { clearTimeout(timeoutId); resolve({ success: true }); })
        .catch(() => { clearTimeout(timeoutId); resolve({ success: false }); });
      });
    }

    // ==================== RECAP ====================
    let currentRecapDate = '';
    
    async function showTodayRecap() {
      const today = new Date().toLocaleDateString('id-ID');
      currentRecapDate = today;
      currentStatusCardDate = today;
      document.getElementById('todayRecapDate').textContent = today;
      
      showPage('todayRecapPage');
      
      document.getElementById('todayRecapContent').innerHTML = `
        <div class="p-8 flex flex-col items-center justify-center">
          <div class="loading-spinner mb-4"></div>
          <p class="text-gray-600">Memuat data dari spreadsheet...</p>
        </div>
      `;
      document.getElementById('todayStatusCards').innerHTML = '';
      
      console.log('Fetching data terbaru dari Google Sheets...');
      const freshData = await fetchRecapDataFromSheet();
      allAbsensiData = freshData;
      console.log('Data berhasil diperbarui. Total:', allAbsensiData.length);
      
      const todayData = allAbsensiData.filter(d => d.date === today && d.type === 'attendance');
      console.log('Data hari ini ditemukan:', todayData.length);
      
      renderStatusCards('todayStatusCards', today, allAbsensiData);
      renderRecapTable(todayData, 'todayRecapContent');
    }

    async function showDateRecap(dateStr) {
      currentRecapDate = dateStr;
      currentStatusCardDate = dateStr;
      document.getElementById('dateRecapTitle').textContent = `Recap: ${dateStr}`;
      
      showPage('dateRecapPage');
      
      document.getElementById('dateRecapContent').innerHTML = `
        <div class="p-8 flex flex-col items-center justify-center">
          <div class="loading-spinner mb-4"></div>
          <p class="text-gray-600">Memuat data dari spreadsheet...</p>
        </div>
      `;
      document.getElementById('dateStatusCards').innerHTML = '';
      
      console.log('Fetching data terbaru dari Google Sheets...');
      const freshData = await fetchRecapDataFromSheet();
      allAbsensiData = freshData;
      
      renderStatusCards('dateStatusCards', dateStr, allAbsensiData);
      
      const dateData = allAbsensiData.filter(d => d.date === dateStr && d.type === 'attendance');
      renderRecapTable(dateData, 'dateRecapContent');
    }

    function renderRecapTable(data, containerId) {
      const container = document.getElementById(containerId);
      
      if (data.length === 0) {
        container.innerHTML = '<div class="p-8 text-center text-gray-500"><p>Tidak ada data absensi untuk tanggal ini</p></div>';
        return;
      }
      
      const statusBgColors = {
        'Start Work': '#22c55e',
        'Finish Work': '#3b82f6',
        'Sakit': '#f97316',
        'Standby': '#a855f7',
        'Belum Absen': '#ef4444'
      };
      
      const timeGroups = {};
      data.forEach(item => {
        if (!timeGroups[item.time]) timeGroups[item.time] = {};
        timeGroups[item.time][item.worker_name] = item.status;
      });
      
      const times = Object.keys(timeGroups).sort((a, b) => {
        const parseTime = (t) => {
          if (!t) return 0;
          const parts = t.split(':');
          return parseInt(parts[0] || 0) * 60 + parseInt(parts[1] || 0);
        };
        return parseTime(a) - parseTime(b);
      });
      
      const workerNamesInData = [...new Set(data.map(d => d.worker_name))];
      
      let html = `<div class="overflow-x-auto"><table class="w-full border-collapse"><tbody>`;
      
      html += `<tr><td class="border border-gray-300 px-4 py-3 bg-gray-100 font-bold text-gray-700">Jam</td>`;
      times.forEach(time => {
        html += `<td class="border border-gray-300 px-4 py-3 bg-white text-center font-medium">${time}</td>`;
      });
      html += `</tr>`;
      
      workerNamesInData.forEach(workerName => {
        const workerInfo = workers.find(w => w.name === workerName);
        const photo = workerInfo ? workerInfo.photo : '';
        
        html += `<tr><td class="border border-gray-300 px-4 py-3 bg-gray-50"><div class="flex items-center gap-2">`;
        html += photo ? `<img src="${photo}" class="w-8 h-8 rounded-lg object-cover" onerror="this.style.display='none'">` : `<div class="w-8 h-8 flex items-center justify-center bg-gray-200 rounded-lg">${getUserIcon(20)}</div>`;
        html += `<span class="font-medium text-gray-800 text-sm">${workerName}</span></div></td>`;
        
        times.forEach(time => {
          const status = timeGroups[time][workerName] || 'Belum Absen';
          const bgColor = statusBgColors[status];
          html += `<td class="border border-gray-300 px-3 py-2 text-center" style="background-color: ${bgColor};"><span class="text-white font-medium text-sm">${status}</span></td>`;
        });
        
        html += `</tr>`;
      });
      
      html += `</tbody></table></div>`;
      container.innerHTML = html;
    }

    // ==================== WORKER HOURS ====================
    let currentWorkerHoursSource = 'today';
    let currentWorkerHoursDate = '';

    function showWorkerHoursPage(source) {
      currentWorkerHoursSource = source;
      
      if (source === 'today') {
        currentWorkerHoursDate = new Date().toLocaleDateString('id-ID');
      } else {
        currentWorkerHoursDate = currentRecapDate;
      }
      
      document.getElementById('workerHoursDateLabel').textContent = `Tanggal: ${currentWorkerHoursDate}`;
      
      document.getElementById('workerHoursSearch').value = '';
      document.getElementById('workerHoursResults').innerHTML = `
        <div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
          <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
          <p>Ketik nama pekerja untuk melihat recap jam kerja</p>
        </div>
      `;
      
      showPage('workerHoursPage');
    }

    function goBackFromWorkerHours() {
      if (currentWorkerHoursSource === 'today') {
        showPage('todayRecapPage');
      } else {
        showPage('dateRecapPage');
      }
    }

    function calculateWorkerHours(workerName, dateStr) {
      const workerData = allAbsensiData.filter(d => 
        d.worker_name === workerName && 
        d.date === dateStr && 
        d.type === 'attendance'
      );
      
      const startTimes = [];
      const finishTimes = [];
      
      workerData.forEach(d => {
        if (d.status === 'Start Work' && d.time) {
          startTimes.push(d.time);
        } else if (d.status === 'Finish Work' && d.time) {
          finishTimes.push(d.time);
        }
      });
      
      startTimes.sort();
      finishTimes.sort();
      
      if (startTimes.length === 0) {
        return { hasData: false, message: 'Tidak ada data Start Work' };
      }
      
      if (finishTimes.length === 0) {
        return { 
          hasData: true, 
          startTimes, 
          finishTimes: [], 
          totalMinutes: 0, 
          message: 'Belum selesai kerja' 
        };
      }
      
      let totalMinutes = 0;
      const pairs = Math.min(startTimes.length, finishTimes.length);
      
      for (let i = 0; i < pairs; i++) {
        const startParts = startTimes[i].split(':');
        const finishParts = finishTimes[i].split(':');
        
        const startMinutes = parseInt(startParts[0]) * 60 + parseInt(startParts[1] || 0);
        const finishMinutes = parseInt(finishParts[0]) * 60 + parseInt(finishParts[1] || 0);
        
        if (finishMinutes > startMinutes) {
          totalMinutes += finishMinutes - startMinutes;
        }
      }
      
      const hours = Math.floor(totalMinutes / 60);
      const minutes = totalMinutes % 60;
      
      return {
        hasData: true,
        startTimes,
        finishTimes,
        totalMinutes,
        totalFormatted: `${hours} jam ${minutes} menit`,
        message: null
      };
    }

    function renderWorkerHoursResults(searchQuery) {
      const container = document.getElementById('workerHoursResults');
      const query = searchQuery.toLowerCase().trim();
      
      if (!query) {
        container.innerHTML = `
          <div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
            <p>Ketik nama pekerja untuk melihat recap jam kerja</p>
          </div>
        `;
        return;
      }
      
      const filteredWorkers = workers.filter(w => w.name.toLowerCase().includes(query));
      
      if (filteredWorkers.length === 0) {
        container.innerHTML = `
          <div class="bg-white rounded-2xl shadow-lg p-8 text-center text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
            <p>Tidak ditemukan pekerja dengan nama "${searchQuery}"</p>
          </div>
        `;
        return;
      }
      
      let html = '';
      
      filteredWorkers.forEach(worker => {
        const result = calculateWorkerHours(worker.name, currentWorkerHoursDate);
        
        html += `
          <div class="bg-white rounded-2xl shadow-lg p-6 fade-in">
            <div class="flex items-center gap-4 mb-4">
              <div class="flex-shrink-0">${getWorkerPhotoHtml(worker, 60)}</div>
              <div>
                <h3 class="text-xl font-bold text-gray-800">${worker.name}</h3>
                <p class="text-sm text-gray-500">${currentWorkerHoursDate}</p>
              </div>
            </div>
            
            <div class="border-t pt-4 space-y-3">
              ${result.hasData ? `
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-green-500"></div>
                  <span class="text-gray-600 font-medium">Start Work:</span>
                  <span class="text-gray-800">${result.startTimes.length > 0 ? result.startTimes.join(', ') : '-'}</span>
                </div>
                <div class="flex items-center gap-3">
                  <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                  <span class="text-gray-600 font-medium">Finish Work:</span>
                  <span class="text-gray-800">${result.finishTimes.length > 0 ? result.finishTimes.join(', ') : '-'}</span>
                </div>
                <div class="flex items-center gap-3 pt-2 border-t">
                  <svg class="w-5 h-5 text-amber-500" fill="currentColor" viewBox="0 0 24 24"><path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z"/></svg>
                  <span class="text-gray-600 font-medium">Total Jam Kerja:</span>
                  <span class="text-lg font-bold ${result.message ? 'text-red-500' : 'text-amber-600'}">${result.message || result.totalFormatted}</span>
                </div>
              ` : `
                <div class="text-center py-4 text-gray-500">
                  <p>${result.message}</p>
                </div>
              `}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    // ==================== CALENDAR ====================
    function renderCalendar() {
      const year = calendarDate.getFullYear();
      const month = calendarDate.getMonth();
      const monthNames = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
      
      document.getElementById('calendarMonth').textContent = `${monthNames[month]} ${year}`;
      
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const datesWithData = new Set(allAbsensiData.filter(d => d.type === 'attendance').map(d => d.date));
      
      const container = document.getElementById('calendarDays');
      container.innerHTML = '';
      
      for (let i = 0; i < firstDay; i++) {
        container.innerHTML += '<div class="p-2"></div>';
      }
      
      for (let day = 1; day <= daysInMonth; day++) {
        const dateStr = new Date(year, month, day).toLocaleDateString('id-ID');
        const hasData = datesWithData.has(dateStr);
        
        const dayEl = document.createElement('button');
        dayEl.className = `calendar-day p-2 text-center rounded-lg transition-all ${hasData ? 'has-data' : 'hover:bg-gray-100'}`;
        dayEl.textContent = day;
        dayEl.onclick = () => showDateRecap(dateStr);
        
        container.appendChild(dayEl);
      }
    }

    function changeMonth(delta) {
      calendarDate.setMonth(calendarDate.getMonth() + delta);
      renderCalendar();
    }

    // ==================== NAVIGATION ====================
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      if (pageId === 'calendarPage') renderCalendar();
    }

    // ==================== CLOCK ====================
    function updateClock() {
      const now = new Date();
      const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      
      const dateStr = now.toLocaleDateString('id-ID', dateOptions);
      const timeStr = now.toLocaleTimeString('id-ID', timeOptions);
      
      const offset = now.getTimezoneOffset();
      const tz = offset === -420 ? 'WIB' : offset === -480 ? 'WITA' : offset === -540 ? 'WIT' : 'WIB';
      
      ['currentDate', 'currentDateRecap'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = dateStr;
      });
      
      ['currentTime', 'currentTimeRecap'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = timeStr;
      });
      
      ['timezone', 'timezoneRecap'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = tz;
      });
    }

    setInterval(updateClock, 1000);
    updateClock();

    // ==================== UTILITIES ====================
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.className = `fixed top-4 right-4 px-6 py-3 rounded-xl shadow-xl z-50 toast ${type === 'error' ? 'bg-red-500' : 'bg-green-500'} text-white`;
      document.getElementById('toastMessage').textContent = message;
      toast.classList.remove('hidden');
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }

    function openSetupGuide() {
      document.getElementById('setupGuideModal').classList.remove('hidden');
      document.getElementById('scriptUrlInput').value = GOOGLE_SCRIPT_URL;
    }

    function closeSetupGuide() {
      document.getElementById('setupGuideModal').classList.add('hidden');
    }

    function copyAppsScript() {
      const code = document.getElementById('appsScriptCode').textContent;
      navigator.clipboard.writeText(code).then(() => showToast('Kode berhasil dicopy!'));
    }

    function saveScriptUrl() {
      const url = document.getElementById('scriptUrlInput').value.trim();
      if (!url.startsWith('https://script.google.com/')) {
        showToast('URL tidak valid!', 'error');
        return;
      }
      localStorage.setItem('googleScriptUrl', url);
      GOOGLE_SCRIPT_URL = url;
      showToast('URL berhasil disimpan!');
      closeSetupGuide();
    }

    // ==================== STATUS CARD POPUP ====================
    function getWorkersByStatus(statusType, dateStr, dataSource = null) {
      let sourceData = dataSource || allAbsensiData;
      const dateData = sourceData.filter(d => d.date === dateStr && d.type === 'attendance');
      
      const workerStatusMap = {};
      dateData.forEach(d => {
        if (!workerStatusMap[d.worker_name]) {
          workerStatusMap[d.worker_name] = new Set();
        }
        workerStatusMap[d.worker_name].add(d.status);
      });
      
      const result = [];
      
      if (statusType === 'Belum Absen') {
        // Cari pekerja yang belum punya status apapun atau hanya punya status "Belum Absen"
        const workersWithStatus = new Set();
        Object.entries(workerStatusMap).forEach(([name, statuses]) => {
          const hasRealStatus = [...statuses].some(s => s !== 'Belum Absen');
          if (hasRealStatus) {
            workersWithStatus.add(name);
          }
        });
        
        workers.forEach(w => {
          if (!workersWithStatus.has(w.name)) {
            result.push(w);
          }
        });
      } else {
        // Cari pekerja dengan status tertentu
        Object.entries(workerStatusMap).forEach(([name, statuses]) => {
          if (statuses.has(statusType)) {
            const workerInfo = workers.find(w => w.name === name);
            if (workerInfo) {
              result.push(workerInfo);
            } else {
              result.push({ name: name, photo: '' });
            }
          }
        });
      }
      
      return result;
    }
    
    function showStatusCardPopup(statusType) {
      const popup = document.getElementById('statusCardPopup');
      const header = document.getElementById('statusCardPopupHeader');
      const title = document.getElementById('statusCardPopupTitle');
      const content = document.getElementById('statusCardPopupContent');
      
      // Set warna header sesuai status
      const statusColors = {
        'Start Work': 'bg-green-500',
        'Finish Work': 'bg-blue-500',
        'Sakit': 'bg-orange-500',
        'Standby': 'bg-purple-500',
        'Belum Absen': 'bg-red-500'
      };
      
      header.className = `px-6 py-4 flex items-center justify-between ${statusColors[statusType] || 'bg-gray-500'}`;
      title.textContent = `Daftar Pekerja - ${statusType}`;
      
      // Ambil data pekerja dengan status tersebut
      const workersList = getWorkersByStatus(statusType, currentStatusCardDate);
      
      if (workersList.length === 0) {
        content.innerHTML = `
          <div class="text-center py-8 text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="currentColor" viewBox="0 0 24 24">
              <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
            </svg>
            <p>Tidak ada pekerja dengan status ini</p>
          </div>
        `;
      } else {
        content.innerHTML = `
          <div class="space-y-3">
            ${workersList.map((worker, index) => `
              <div class="flex items-center gap-3 p-3 bg-gray-50 rounded-xl fade-in" style="animation-delay: ${index * 0.05}s">
                <div class="flex-shrink-0">
                  ${worker.photo ? 
                    `<img src="${worker.photo}" alt="${worker.name}" class="w-12 h-12 rounded-xl object-cover" onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
                     <div style="display:none;width:48px;height:48px;border-radius:12px;" class="flex items-center justify-center bg-gray-200">${getUserIcon(28)}</div>` :
                    `<div class="w-12 h-12 flex items-center justify-center bg-gray-200 rounded-xl">${getUserIcon(28)}</div>`
                  }
                </div>
                <div class="flex-1">
                  <h4 class="font-semibold text-gray-800">${worker.name}</h4>
                </div>
                <div class="flex-shrink-0">
                  <span class="px-3 py-1 text-xs font-medium text-white rounded-full ${statusColors[statusType]}">${statusType}</span>
                </div>
              </div>
            `).join('')}
          </div>
          <div class="mt-4 pt-4 border-t text-center text-sm text-gray-500">
            Total: <span class="font-bold">${workersList.length}</span> pekerja
          </div>
        `;
      }
      
      popup.classList.remove('hidden');
    }
    
    function closeStatusCardPopup() {
      document.getElementById('statusCardPopup').classList.add('hidden');
    }

    // ==================== STATUS SUMMARY ====================
    function generateStatusCardsHTML(dateStr, dataSource = null) {
      let sourceData = dataSource || allAbsensiData;
      const dateData = sourceData.filter(d => d.date === dateStr && d.type === 'attendance');
      
      const workerStatusMap = {};
      dateData.forEach(d => {
        if (!workerStatusMap[d.worker_name]) {
          workerStatusMap[d.worker_name] = new Set();
        }
        workerStatusMap[d.worker_name].add(d.status);
      });
      
      let startWork = 0;
      let finishWork = 0;
      let sakit = 0;
      let standby = 0;
      
      Object.values(workerStatusMap).forEach(statuses => {
        if (statuses.has('Start Work')) startWork++;
        if (statuses.has('Finish Work')) finishWork++;
        if (statuses.has('Sakit')) sakit++;
        if (statuses.has('Standby')) standby++;
      });
      
      const workersWithStatus = new Set();
      Object.entries(workerStatusMap).forEach(([name, statuses]) => {
        const hasRealStatus = [...statuses].some(s => s !== 'Belum Absen');
        if (hasRealStatus) {
          workersWithStatus.add(name);
        }
      });
      
      const totalWorkers = workers.length || Object.keys(workerStatusMap).length;
      const belumAbsen = Math.max(0, totalWorkers - workersWithStatus.size);
      
      return `
        <div class="bg-green-500 rounded-xl p-4 text-white shadow-lg text-center">
          <div class="font-semibold text-sm mb-2">Start Work</div>
          <div class="text-5xl font-bold">${startWork}</div>
          <div class="text-xs opacity-80 mt-1">dari ${totalWorkers} pekerja</div>
        </div>
        
        <div class="bg-blue-500 rounded-xl p-4 text-white shadow-lg text-center">
          <div class="font-semibold text-sm mb-2">Finish Work</div>
          <div class="text-5xl font-bold">${finishWork}</div>
          <div class="text-xs opacity-80 mt-1">dari ${totalWorkers} pekerja</div>
        </div>
        
        <div onclick="showStatusCardPopup('Sakit')" class="bg-orange-500 rounded-xl p-4 text-white shadow-lg text-center status-card-clickable">
          <div class="font-semibold text-sm mb-2">Sakit</div>
          <div class="text-5xl font-bold">${sakit}</div>
          <div class="text-xs opacity-80 mt-1">dari ${totalWorkers} pekerja</div>
          <div class="text-xs mt-2 opacity-70"> Klik untuk detail</div>
        </div>
        
        <div onclick="showStatusCardPopup('Standby')" class="bg-purple-500 rounded-xl p-4 text-white shadow-lg text-center status-card-clickable">
          <div class="font-semibold text-sm mb-2">Standby</div>
          <div class="text-5xl font-bold">${standby}</div>
          <div class="text-xs opacity-80 mt-1">dari ${totalWorkers} pekerja</div>
          <div class="text-xs mt-2 opacity-70"> Klik untuk detail</div>
        </div>
        
        <div class="bg-red-500 rounded-xl p-4 text-white shadow-lg text-center">
          <div class="font-semibold text-sm mb-2">Belum Absen</div>
          <div class="text-5xl font-bold">${belumAbsen}</div>
          <div class="text-xs opacity-80 mt-1">dari ${totalWorkers} pekerja</div>
        </div>
      `;
    }
    
    function renderStatusCards(containerId, dateStr, dataSource = null) {
      const container = document.getElementById(containerId);
      if (container) {
        container.innerHTML = generateStatusCardsHTML(dateStr, dataSource);
      }
    }

    // ==================== REFRESH DATA FUNCTION ====================
    async function refreshDataFromSheet(page) {
      const btnId = page === 'today' ? 'refreshBtnToday' : 'refreshBtnDate';
      const btn = document.getElementById(btnId);
      const icon = btn.querySelector('.refresh-icon');
      
      btn.classList.add('btn-loading');
      icon.classList.add('spinning');
      btn.innerHTML = `<svg class="w-5 h-5 refresh-icon spinning" fill="white" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg> Memuat...`;
      
      try {
        console.log(' Refreshing data from Google Sheets...');
        const freshData = await fetchRecapDataFromSheet();
        allAbsensiData = freshData;
        console.log(` Data refreshed! Total: ${allAbsensiData.length} records`);
        
        if (page === 'today') {
          const today = new Date().toLocaleDateString('id-ID');
          currentStatusCardDate = today;
          const todayData = allAbsensiData.filter(d => d.date === today && d.type === 'attendance');
          renderStatusCards('todayStatusCards', today, allAbsensiData);
          renderRecapTable(todayData, 'todayRecapContent');
        } else {
          currentStatusCardDate = currentRecapDate;
          const dateData = allAbsensiData.filter(d => d.date === currentRecapDate && d.type === 'attendance');
          renderStatusCards('dateStatusCards', currentRecapDate, allAbsensiData);
          renderRecapTable(dateData, 'dateRecapContent');
        }
        
        showToast(`Data berhasil diperbarui! (${allAbsensiData.length} record)`);
        
      } catch (error) {
        console.error(' Error refreshing data:', error);
        showToast('Gagal memperbarui data!', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.innerHTML = `<svg class="w-5 h-5 refresh-icon" fill="white" viewBox="0 0 24 24"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg> Refresh Data`;
    }

    // ==================== ELEMENT SDK ====================
    async function initElementSdk() {
      if (window.elementSdk) {
        await window.elementSdk.init({
          defaultConfig,
          onConfigChange: async (newConfig) => {
            config = { ...defaultConfig, ...newConfig };
            document.getElementById('appTitleHeader').textContent = config.app_title || defaultConfig.app_title;
            document.getElementById('companyNameLogin').textContent = config.company_name || defaultConfig.company_name;
          },
          mapToCapabilities: () => ({ recolorables: [], borderables: [], fontEditable: undefined, fontSizeable: undefined }),
          mapToEditPanelValues: (cfg) => new Map([
            ['app_title', cfg.app_title || defaultConfig.app_title],
            ['company_name', cfg.company_name || defaultConfig.company_name]
          ])
        });
        config = { ...defaultConfig, ...window.elementSdk.config };
      }
    }

    // ==================== DATA SDK ====================
    const dataHandler = {
      onDataChanged(data) {}
    };

    async function initDataSdk() {
      if (window.dataSdk) {
        await window.dataSdk.init(dataHandler);
      }
    }

    // ==================== LOGIN ====================
    document.getElementById('loginForm').addEventListener('submit', function(e) {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (username === 'archipelago' && password === 'balivibes') {
        document.getElementById('loginError').classList.add('hidden');
        showPage('absensiPage');
        getCurrentLocation();
      } else {
        document.getElementById('loginError').classList.remove('hidden');
      }
    });

    // ==================== INIT ====================
    async function init() {
      await initElementSdk();
      await initDataSdk();
      
      await fetchWorkersFromSheet();
      renderWorkerGrid();
      
      console.log('Fetching recap data from Google Sheets...');
      const recapData = await fetchRecapDataFromSheet();
      allAbsensiData = recapData;
      console.log(`Loaded ${allAbsensiData.length} total attendance records`);
      
      const workerHoursSearch = document.getElementById('workerHoursSearch');
      if (workerHoursSearch) {
        workerHoursSearch.addEventListener('input', (e) => {
          renderWorkerHoursResults(e.target.value);
        });
      }
    }

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b6f09db10064ad6',t:'MTc2NzIzOTI4MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
